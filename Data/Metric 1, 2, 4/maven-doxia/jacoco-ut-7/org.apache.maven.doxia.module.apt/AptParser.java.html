<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AptParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Doxia :: APT Module</a> &gt; <a href="index.source.html" class="el_package">org.apache.maven.doxia.module.apt</a> &gt; <span class="el_source">AptParser.java</span></div><h1>AptParser.java</h1><pre class="source lang-java linenums">package org.apache.maven.doxia.module.apt;

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

import org.apache.maven.doxia.macro.MacroExecutionException;
import org.apache.maven.doxia.macro.MacroRequest;
import org.apache.maven.doxia.macro.manager.MacroNotFoundException;
import org.apache.maven.doxia.parser.AbstractTextParser;
import org.apache.maven.doxia.parser.ParseException;
import org.apache.maven.doxia.parser.Parser;
import org.apache.maven.doxia.sink.Sink;
import org.apache.maven.doxia.sink.SinkEventAttributes;
import org.apache.maven.doxia.sink.impl.SinkAdapter;
import org.apache.maven.doxia.sink.impl.SinkEventAttributeSet;
import org.apache.maven.doxia.util.DoxiaUtils;

import org.codehaus.plexus.component.annotations.Component;
import org.codehaus.plexus.util.IOUtil;
import org.codehaus.plexus.util.StringUtils;

import java.io.IOException;
import java.io.Reader;
import java.io.StringReader;
import java.io.StringWriter;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TreeSet;

/**
 * The APT parser.
 * &lt;br&gt;
 * Based on the &lt;a href=&quot;http://www.xmlmind.com/aptconvert.html&quot;&gt;APTconvert&lt;/a&gt; project.
 *
 * @since 1.0
 */
@Component( role = Parser.class, hint = &quot;apt&quot; )
<span class="fc" id="L56">public class AptParser</span>
    extends AbstractTextParser
    implements AptMarkup
{
    /** Title event id */
    private static final int TITLE = 0;

    /** Section 1 event id */
    private static final int SECTION1 = 1;

    /** Section 2 event id */
    private static final int SECTION2 = 2;

    /** Section 3 event id */
    private static final int SECTION3 = 3;

    /** Section 4 event id */
    private static final int SECTION4 = 4;

    /** Section 5 event id */
    private static final int SECTION5 = 5;

    /** Paragraph event id */
    private static final int PARAGRAPH = 6;

    /** Verbatim event id */
    private static final int VERBATIM = 7;

    /** Figure event id */
    private static final int FIGURE = 8;

    /** Table event id */
    private static final int TABLE = 9;

    /** List event id */
    private static final int LIST_ITEM = 10;

    /** Numbered list event id */
    private static final int NUMBERED_LIST_ITEM = 11;

    /** Definition list event id */
    private static final int DEFINITION_LIST_ITEM = 12;

    /** Horizontal rule event id */
    private static final int HORIZONTAL_RULE = 13;

    /** Page break event id */
    private static final int PG_BREAK = 14;

    /** List break event id */
    private static final int LIST_BREAK = 15;

    /** Macro event id */
    private static final int MACRO = 16;

    /** Comment event id. */
    private static final int COMMENT_BLOCK = 17;

    /** String representations of event ids */
<span class="fc" id="L115">    private static final String[] TYPE_NAMES = {</span>
        &quot;TITLE&quot;,
        &quot;SECTION1&quot;,
        &quot;SECTION2&quot;,
        &quot;SECTION3&quot;,
        &quot;SECTION4&quot;,
        &quot;SECTION5&quot;,
        &quot;PARAGRAPH&quot;,
        &quot;VERBATIM&quot;,
        &quot;FIGURE&quot;,
        &quot;TABLE&quot;,
        &quot;LIST_ITEM&quot;,
        &quot;NUMBERED_LIST_ITEM&quot;,
        &quot;DEFINITION_LIST_ITEM&quot;,
        &quot;HORIZONTAL_RULE&quot;,
        &quot;PG_BREAK&quot;,
        &quot;LIST_BREAK&quot;,
        &quot;MACRO&quot;,
        &quot;COMMENT_BLOCK&quot; };

    /** An array of 85 spaces. */
    protected static final char[] SPACES;

    /** Default tab width. */
    public static final int TAB_WIDTH = 8;

    // ----------------------------------------------------------------------
    // Instance fields
    // ----------------------------------------------------------------------

    /** the AptSource. */
    private AptSource source;

    /** a block of AptSource. */
    private Block block;

    /** blockFileName. */
    private String blockFileName;

    /** blockLineNumber. */
    private int blockLineNumber;

    /** sourceContent. */
    protected String sourceContent;

    /** the sink to receive the events. */
    protected Sink sink;

    /** a line of AptSource. */
    protected String line;

    /** Map of warn messages with a String as key to describe the error type and a Set as value.
     * Using to reduce warn messages. */
    protected Map&lt;String, Set&lt;String&gt;&gt; warnMessages;

    private static final int NUMBER_OF_SPACES = 85;

    static
    {
<span class="fc" id="L174">        SPACES = new char[NUMBER_OF_SPACES];</span>

<span class="fc bfc" id="L176" title="All 2 branches covered.">        for ( int i = 0; i &lt; NUMBER_OF_SPACES; i++ )</span>
        {
<span class="fc" id="L178">            SPACES[i] = ' ';</span>
        }
<span class="fc" id="L180">    }</span>

    // ----------------------------------------------------------------------
    // Public methods
    // ----------------------------------------------------------------------

    /** {@inheritDoc} */
    @Override
    public void parse( Reader source, Sink sink )
        throws ParseException
    {
<span class="fc" id="L191">        parse( source, sink, &quot;&quot; );</span>
<span class="fc" id="L192">    }</span>
    
    /** {@inheritDoc} */
    @Override
    public void parse( Reader source, Sink sink, String reference )
        throws ParseException
    {
<span class="fc" id="L199">        init();</span>

        try
        {
<span class="fc" id="L203">            StringWriter contentWriter = new StringWriter();</span>
<span class="fc" id="L204">            IOUtil.copy( source, contentWriter );</span>
<span class="fc" id="L205">            sourceContent = contentWriter.toString();</span>
        }
<span class="nc" id="L207">        catch ( IOException e )</span>
        {
<span class="nc" id="L209">            throw new AptParseException( &quot;IOException: &quot; + e.getMessage(), e );</span>
<span class="fc" id="L210">        }</span>

        try
        {
<span class="fc" id="L214">            this.source = new AptReaderSource( new StringReader( sourceContent ), reference );</span>

<span class="fc" id="L216">            this.sink = sink;</span>
<span class="fc" id="L217">            sink.enableLogging( getLog() );</span>

<span class="fc" id="L219">            blockFileName = null;</span>

<span class="fc" id="L221">            blockLineNumber = -1;</span>

            // Lookahead line.
<span class="fc" id="L224">            nextLine();</span>

            // Lookahead block.
<span class="fc" id="L227">            nextBlock( /*first*/true );</span>

            // traverse comments
<span class="pc bpc" id="L230" title="1 of 4 branches missed.">            while ( ( block != null ) &amp;&amp; ( block.getType() == COMMENT_BLOCK ) )</span>
            {
<span class="fc" id="L232">                block.traverse();</span>
<span class="fc" id="L233">                nextBlock( /*first*/true );</span>
            }

<span class="fc" id="L236">            traverseHead();</span>

<span class="fc" id="L238">            traverseBody();</span>
        }
<span class="nc" id="L240">        catch ( AptParseException ape )</span>
        {
            // TODO handle column number
<span class="nc" id="L243">            throw new AptParseException( ape.getMessage(), ape, getSourceName(), getSourceLineNumber(), -1 );</span>
        }
        finally
        {
<span class="fc" id="L247">            logWarnings();</span>

<span class="fc" id="L249">            setSecondParsing( false );</span>
<span class="fc" id="L250">            init();</span>
        }
<span class="fc" id="L252">    }</span>

    /**
     * Returns the name of the Apt source document.
     *
     * @return the source name.
     */
    public String getSourceName()
    {
        // Use this rather than source.getName() to report errors.
<span class="nc" id="L262">        return blockFileName;</span>
    }

    /**
     * Returns the current line number of the Apt source document.
     *
     * @return the line number.
     */
    public int getSourceLineNumber()
    {
        // Use this rather than source.getLineNumber() to report errors.
<span class="nc" id="L273">        return blockLineNumber;</span>
    }

    // ----------------------------------------------------------------------
    // Protected methods
    // ----------------------------------------------------------------------

    /**
     * Parse the next line of the Apt source document.
     *
     * @throws org.apache.maven.doxia.module.apt.AptParseException if something goes wrong.
     */
    protected void nextLine()
        throws AptParseException
    {
<span class="fc" id="L288">        line = source.getNextLine();</span>
<span class="fc" id="L289">    }</span>

    /**
     * Parse the given text.
     *
     * @param text the text to parse.
     * @param begin offset.
     * @param end offset.
     * @param sink the sink to receive the events.
     * @throws org.apache.maven.doxia.module.apt.AptParseException if something goes wrong.
     */
    protected void doTraverseText( String text, int begin, int end, Sink sink )
        throws AptParseException
    {
<span class="fc" id="L303">        boolean anchor = false;</span>
<span class="fc" id="L304">        boolean link = false;</span>
<span class="fc" id="L305">        boolean italic = false;</span>
<span class="fc" id="L306">        boolean bold = false;</span>
<span class="fc" id="L307">        boolean monospaced = false;</span>
<span class="fc" id="L308">        StringBuilder buffer = new StringBuilder( end - begin );</span>

<span class="fc bfc" id="L310" title="All 2 branches covered.">        for ( int i = begin; i &lt; end; ++i )</span>
        {
<span class="fc" id="L312">            char c = text.charAt( i );</span>
<span class="fc bfc" id="L313" title="All 6 branches covered.">            switch ( c )</span>
            {
                case BACKSLASH:
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">                    if ( i + 1 &lt; end )</span>
                    {
<span class="fc" id="L318">                        char escaped = text.charAt( i + 1 );</span>
<span class="fc bfc" id="L319" title="All 6 branches covered.">                        switch ( escaped )</span>
                        {
                            case SPACE:
<span class="fc" id="L322">                                ++i;</span>
<span class="fc" id="L323">                                flushTraversed( buffer, sink );</span>
<span class="fc" id="L324">                                sink.nonBreakingSpace();</span>
<span class="fc" id="L325">                                break;</span>
                            case '\r':
                            case '\n':
<span class="fc" id="L328">                                ++i;</span>
                                // Skip white space which may follow a line break.
<span class="pc bpc" id="L330" title="1 of 4 branches missed.">                                while ( i + 1 &lt; end &amp;&amp; Character.isWhitespace( text.charAt( i + 1 ) ) )</span>
                                {
<span class="fc" id="L332">                                    ++i;</span>
                                }
<span class="fc" id="L334">                                flushTraversed( buffer, sink );</span>
<span class="fc" id="L335">                                sink.lineBreak();</span>
<span class="fc" id="L336">                                break;</span>
                            case BACKSLASH:
                            case PIPE:
                            case COMMENT:
                            case EQUAL:
                            case MINUS:
                            case PLUS:
                            case STAR:
                            case LEFT_SQUARE_BRACKET:
                            case RIGHT_SQUARE_BRACKET:
                            case LESS_THAN:
                            case GREATER_THAN:
                            case LEFT_CURLY_BRACKET:
                            case RIGHT_CURLY_BRACKET:
<span class="fc" id="L350">                                ++i;</span>
<span class="fc" id="L351">                                buffer.append( escaped );</span>
<span class="fc" id="L352">                                break;</span>
                            case 'x':
<span class="pc bpc" id="L354" title="2 of 4 branches missed.">                                if ( i + 3 &lt; end &amp;&amp; isHexChar( text.charAt( i + 2 ) )</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">                                    &amp;&amp; isHexChar( text.charAt( i + 3 ) ) )</span>
                                {
<span class="fc" id="L357">                                    int value = '?';</span>
                                    try
                                    {
<span class="fc" id="L360">                                        value = Integer.parseInt( text.substring( i + 2, i + 4 ), 16 );</span>
                                    }
<span class="nc" id="L362">                                    catch ( NumberFormatException e )</span>
                                    {
<span class="nc bnc" id="L364" title="All 2 branches missed.">                                        if ( getLog().isDebugEnabled() )</span>
                                        {
<span class="nc" id="L366">                                            getLog().debug( &quot;Not a number: &quot; + text.substring( i + 2, i + 4 ) );</span>
                                        }
<span class="fc" id="L368">                                    }</span>

<span class="fc" id="L370">                                    i += 3;</span>
<span class="fc" id="L371">                                    buffer.append( (char) value );</span>
<span class="fc" id="L372">                                }</span>
                                else
                                {
<span class="nc" id="L375">                                    buffer.append( BACKSLASH );</span>
                                }
<span class="nc" id="L377">                                break;</span>
                            case 'u':
<span class="pc bpc" id="L379" title="2 of 4 branches missed.">                                if ( i + 5 &lt; end &amp;&amp; isHexChar( text.charAt( i + 2 ) )</span>
<span class="pc bpc" id="L380" title="2 of 4 branches missed.">                                    &amp;&amp; isHexChar( text.charAt( i + 3 ) ) &amp;&amp; isHexChar( text.charAt( i + 4 ) )</span>
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">                                    &amp;&amp; isHexChar( text.charAt( i + 5 ) ) )</span>
                                {
<span class="fc" id="L383">                                    int value = '?';</span>
                                    try
                                    {
<span class="fc" id="L386">                                        value = Integer.parseInt( text.substring( i + 2, i + 6 ), 16 );</span>
                                    }
<span class="nc" id="L388">                                    catch ( NumberFormatException e )</span>
                                    {
<span class="nc bnc" id="L390" title="All 2 branches missed.">                                        if ( getLog().isDebugEnabled() )</span>
                                        {
<span class="nc" id="L392">                                            getLog().debug( &quot;Not a number: &quot; + text.substring( i + 2, i + 6 ) );</span>
                                        }
<span class="fc" id="L394">                                    }</span>

<span class="fc" id="L396">                                    i += 5;</span>
<span class="fc" id="L397">                                    buffer.append( (char) value );</span>
<span class="fc" id="L398">                                }</span>
                                else
                                {
<span class="nc" id="L401">                                    buffer.append( BACKSLASH );</span>
                                }
<span class="nc" id="L403">                                break;</span>
                            default:
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">                                if ( isOctalChar( escaped ) )</span>
                                {
<span class="fc" id="L407">                                    int octalChars = 1;</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">                                    if ( isOctalChar( charAt( text, end, i + 2 ) ) )</span>
                                    {
<span class="fc" id="L410">                                        ++octalChars;</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">                                        if ( isOctalChar( charAt( text, end, i + 3 ) ) )</span>
                                        {
<span class="fc" id="L413">                                            ++octalChars;</span>
                                        }
                                    }
<span class="fc" id="L416">                                    int value = '?';</span>
                                    try
                                    {
<span class="fc" id="L419">                                        value = Integer.parseInt( text.substring( i + 1, i + 1 + octalChars ), 8 );</span>
                                    }
<span class="nc" id="L421">                                    catch ( NumberFormatException e )</span>
                                    {
<span class="nc bnc" id="L423" title="All 2 branches missed.">                                        if ( getLog().isDebugEnabled() )</span>
                                        {
<span class="nc" id="L425">                                            getLog().debug(</span>
                                                            &quot;Not a number: &quot;
<span class="nc" id="L427">                                                                + text.substring( i + 1, i + 1 + octalChars ) );</span>
                                        }
<span class="fc" id="L429">                                    }</span>

<span class="fc" id="L431">                                    i += octalChars;</span>
<span class="fc" id="L432">                                    buffer.append( (char) value );</span>
<span class="fc" id="L433">                                }</span>
                                else
                                {
<span class="nc" id="L436">                                    buffer.append( BACKSLASH );</span>
                                }
                        }
<span class="fc" id="L439">                    }</span>
                    else
                    {
<span class="nc" id="L442">                        buffer.append( BACKSLASH );</span>
                    }
<span class="nc" id="L444">                    break;</span>

                case LEFT_CURLY_BRACKET: /*}*/
<span class="pc bpc" id="L447" title="2 of 4 branches missed.">                    if ( !anchor &amp;&amp; !link )</span>
                    {
<span class="pc bpc" id="L449" title="1 of 4 branches missed.">                        if ( i + 1 &lt; end &amp;&amp; text.charAt( i + 1 ) == LEFT_CURLY_BRACKET /*}*/ )</span>
                        {
<span class="fc" id="L451">                            ++i;</span>
<span class="fc" id="L452">                            link = true;</span>
<span class="fc" id="L453">                            flushTraversed( buffer, sink );</span>

<span class="fc" id="L455">                            String linkAnchor = null;</span>

<span class="pc bpc" id="L457" title="1 of 4 branches missed.">                            if ( i + 1 &lt; end &amp;&amp; text.charAt( i + 1 ) == LEFT_CURLY_BRACKET /*}*/ )</span>
                            {
<span class="fc" id="L459">                                ++i;</span>
<span class="fc" id="L460">                                StringBuilder buf = new StringBuilder();</span>
<span class="fc" id="L461">                                i = skipTraversedLinkAnchor( text, i + 1, end, buf );</span>
<span class="fc" id="L462">                                linkAnchor = buf.toString();</span>
                            }

<span class="fc bfc" id="L465" title="All 2 branches covered.">                            if ( linkAnchor == null )</span>
                            {
<span class="fc" id="L467">                                linkAnchor = getTraversedLink( text, i + 1, end );</span>
                            }

<span class="fc bfc" id="L470" title="All 2 branches covered.">                            if ( AptUtils.isInternalLink( linkAnchor ) )</span>
                            {
<span class="fc" id="L472">                                linkAnchor = &quot;#&quot; + linkAnchor;</span>
                            }

<span class="fc" id="L475">                            int hashIndex = linkAnchor.indexOf( &quot;#&quot; );</span>

<span class="fc bfc" id="L477" title="All 4 branches covered.">                            if ( hashIndex != -1 &amp;&amp; !AptUtils.isExternalLink( linkAnchor ) )</span>
                            {
<span class="fc" id="L479">                                String hash = linkAnchor.substring( hashIndex + 1 );</span>

<span class="pc bpc" id="L481" title="3 of 4 branches missed.">                                if ( hash.endsWith( &quot;.html&quot; ) &amp;&amp; !hash.startsWith( &quot;./&quot; ) )</span>
                                {
<span class="nc" id="L483">                                    String msg = &quot;Ambiguous link: '&quot; + hash</span>
                                            + &quot;'. If this is a local link, prepend \&quot;./\&quot;!&quot;;
<span class="nc" id="L485">                                    logMessage( &quot;ambiguousLink&quot;, msg );</span>
                                }

                                // link##anchor means literal
<span class="fc bfc" id="L489" title="All 2 branches covered.">                                if ( hash.startsWith( &quot;#&quot; ) )</span>
                                {
<span class="fc" id="L491">                                    linkAnchor = linkAnchor.substring( 0, hashIndex ) + hash;</span>
                                }
<span class="fc bfc" id="L493" title="All 2 branches covered.">                                else if ( !DoxiaUtils.isValidId( hash ) )</span>
                                {
<span class="fc" id="L495">                                    linkAnchor =</span>
<span class="fc" id="L496">                                        linkAnchor.substring( 0, hashIndex ) + &quot;#&quot;</span>
<span class="fc" id="L497">                                            + DoxiaUtils.encodeId( hash, true );</span>

<span class="fc" id="L499">                                    String msg = &quot;Modified invalid link: '&quot; + hash + &quot;' to '&quot; + linkAnchor + &quot;'&quot;;</span>
<span class="fc" id="L500">                                    logMessage( &quot;modifiedLink&quot;, msg );</span>
                                }
                            }

<span class="fc" id="L504">                            sink.link( linkAnchor );</span>
<span class="fc" id="L505">                        }</span>
                        else
                        {
<span class="fc" id="L508">                            anchor = true;</span>
<span class="fc" id="L509">                            flushTraversed( buffer, sink );</span>

<span class="fc" id="L511">                            String linkAnchor = getTraversedAnchor( text, i + 1, end );</span>

<span class="fc" id="L513">                            linkAnchor = AptUtils.encodeAnchor( linkAnchor );</span>

<span class="fc" id="L515">                            sink.anchor( linkAnchor );</span>
<span class="fc" id="L516">                        }</span>
                    }
                    else
                    {
<span class="nc" id="L520">                        buffer.append( c );</span>
                    }
<span class="nc" id="L522">                    break;</span>

                case /*{*/RIGHT_CURLY_BRACKET:
<span class="pc bpc" id="L525" title="2 of 6 branches missed.">                    if ( link &amp;&amp; i + 1 &lt; end &amp;&amp; text.charAt( i + 1 ) == /*{*/RIGHT_CURLY_BRACKET )</span>
                    {
<span class="fc" id="L527">                        ++i;</span>
<span class="fc" id="L528">                        link = false;</span>
<span class="fc" id="L529">                        flushTraversed( buffer, sink );</span>
<span class="fc" id="L530">                        sink.link_();</span>
                    }
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">                    else if ( anchor )</span>
                    {
<span class="fc" id="L534">                        anchor = false;</span>
<span class="fc" id="L535">                        flushTraversed( buffer, sink );</span>
<span class="fc" id="L536">                        sink.anchor_();</span>
                    }
                    else
                    {
<span class="nc" id="L540">                        buffer.append( c );</span>
                    }
<span class="nc" id="L542">                    break;</span>

                case LESS_THAN:
<span class="pc bpc" id="L545" title="3 of 6 branches missed.">                    if ( !italic &amp;&amp; !bold &amp;&amp; !monospaced )</span>
                    {
<span class="pc bpc" id="L547" title="1 of 4 branches missed.">                        if ( i + 1 &lt; end &amp;&amp; text.charAt( i + 1 ) == LESS_THAN )</span>
                        {
<span class="pc bpc" id="L549" title="1 of 4 branches missed.">                            if ( i + 2 &lt; end &amp;&amp; text.charAt( i + 2 ) == LESS_THAN )</span>
                            {
<span class="fc" id="L551">                                i += 2;</span>
<span class="fc" id="L552">                                monospaced = true;</span>
<span class="fc" id="L553">                                flushTraversed( buffer, sink );</span>
<span class="fc" id="L554">                                sink.monospaced();</span>
                            }
                            else
                            {
<span class="fc" id="L558">                                ++i;</span>
<span class="fc" id="L559">                                bold = true;</span>
<span class="fc" id="L560">                                flushTraversed( buffer, sink );</span>
<span class="fc" id="L561">                                sink.bold();</span>
                            }
                        }
                        else
                        {
<span class="fc" id="L566">                            italic = true;</span>
<span class="fc" id="L567">                            flushTraversed( buffer, sink );</span>
<span class="fc" id="L568">                            sink.italic();</span>
                        }
                    }
                    else
                    {
<span class="nc" id="L573">                        buffer.append( c );</span>
                    }
<span class="nc" id="L575">                    break;</span>

                case GREATER_THAN:
<span class="pc bpc" id="L578" title="2 of 6 branches missed.">                    if ( monospaced &amp;&amp; i + 2 &lt; end &amp;&amp; text.charAt( i + 1 ) == GREATER_THAN</span>
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">                        &amp;&amp; text.charAt( i + 2 ) == GREATER_THAN )</span>
                    {
<span class="fc" id="L581">                        i += 2;</span>
<span class="fc" id="L582">                        monospaced = false;</span>
<span class="fc" id="L583">                        flushTraversed( buffer, sink );</span>
<span class="fc" id="L584">                        sink.monospaced_();</span>
                    }
<span class="pc bpc" id="L586" title="2 of 6 branches missed.">                    else if ( bold &amp;&amp; i + 1 &lt; end &amp;&amp; text.charAt( i + 1 ) == GREATER_THAN )</span>
                    {
<span class="fc" id="L588">                        ++i;</span>
<span class="fc" id="L589">                        bold = false;</span>
<span class="fc" id="L590">                        flushTraversed( buffer, sink );</span>
<span class="fc" id="L591">                        sink.bold_();</span>
                    }
<span class="pc bpc" id="L593" title="1 of 2 branches missed.">                    else if ( italic )</span>
                    {
<span class="fc" id="L595">                        italic = false;</span>
<span class="fc" id="L596">                        flushTraversed( buffer, sink );</span>
<span class="fc" id="L597">                        sink.italic_();</span>
                    }
                    else
                    {
<span class="nc" id="L601">                        buffer.append( c );</span>
                    }
<span class="nc" id="L603">                    break;</span>

                default:
<span class="fc bfc" id="L606" title="All 2 branches covered.">                    if ( Character.isWhitespace( c ) )</span>
                    {
<span class="fc" id="L608">                        buffer.append( SPACE );</span>

                        // Skip to the last char of a sequence of white spaces.
<span class="pc bpc" id="L611" title="1 of 4 branches missed.">                        while ( i + 1 &lt; end &amp;&amp; Character.isWhitespace( text.charAt( i + 1 ) ) )</span>
                        {
<span class="fc" id="L613">                            ++i;</span>
                        }
                    }
                    else
                    {
<span class="fc" id="L618">                        buffer.append( c );</span>
                    }
            }
        }

<span class="pc bpc" id="L623" title="1 of 2 branches missed.">        if ( monospaced )</span>
        {
<span class="nc" id="L625">            throw new AptParseException( &quot;missing '&quot; + MONOSPACED_END_MARKUP + &quot;'&quot; );</span>
        }
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">        if ( bold )</span>
        {
<span class="nc" id="L629">            throw new AptParseException( &quot;missing '&quot; + BOLD_END_MARKUP + &quot;'&quot; );</span>
        }
<span class="pc bpc" id="L631" title="1 of 2 branches missed.">        if ( italic )</span>
        {
<span class="nc" id="L633">            throw new AptParseException( &quot;missing '&quot; + ITALIC_END_MARKUP + &quot;'&quot; );</span>
        }
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">        if ( link )</span>
        {
<span class="nc" id="L637">            throw new AptParseException( &quot;missing '&quot; + LINK_END_MARKUP + &quot;'&quot; );</span>
        }
<span class="pc bpc" id="L639" title="1 of 2 branches missed.">        if ( anchor )</span>
        {
<span class="nc" id="L641">            throw new AptParseException( &quot;missing '&quot; + ANCHOR_END_MARKUP + &quot;'&quot; );</span>
        }

<span class="fc" id="L644">        flushTraversed( buffer, sink );</span>
<span class="fc" id="L645">    }</span>

    // -----------------------------------------------------------------------

    /**
     * Returns the character at position i of the given string.
     *
     * @param string the string.
     * @param length length.
     * @param i offset.
     * @return the character, or '\0' if i &amp;gt; length.
     */
    protected static char charAt( String string, int length, int i )
    {
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">        return ( i &lt; length ) ? string.charAt( i ) : '\0';</span>
    }

    /**
     * Skip spaces.
     *
     * @param string string.
     * @param length length.
     * @param i offset.
     * @return int.
     */
    protected static int skipSpace( String string, int length, int i )
    {
<span class="fc bfc" id="L672" title="All 2 branches covered.">        loop: for ( ; i &lt; length; ++i )</span>
        {
<span class="fc bfc" id="L674" title="All 2 branches covered.">            switch ( string.charAt( i ) )</span>
            {
                case SPACE:
                case TAB:
<span class="fc" id="L678">                    break;</span>
                default:
<span class="fc" id="L680">                    break loop;</span>
            }
        }
<span class="fc" id="L683">        return i;</span>
    }

    /**
     * Replace part of a string.
     *
     * @param string the string
     * @param oldSub the substring to replace
     * @param newSub the replacement string
     * @return String
     */
    protected static String replaceAll( String string, String oldSub, String newSub )
    {
<span class="fc" id="L696">        StringBuilder replaced = new StringBuilder();</span>
<span class="fc" id="L697">        int oldSubLength = oldSub.length();</span>
        int begin, end;

<span class="fc" id="L700">        begin = 0;</span>
<span class="fc bfc" id="L701" title="All 2 branches covered.">        while ( ( end = string.indexOf( oldSub, begin ) ) &gt;= 0 )</span>
        {
<span class="fc bfc" id="L703" title="All 2 branches covered.">            if ( end &gt; begin )</span>
            {
<span class="fc" id="L705">                replaced.append( string, begin, end );</span>
            }
<span class="fc" id="L707">            replaced.append( newSub );</span>
<span class="fc" id="L708">            begin = end + oldSubLength;</span>
        }
<span class="fc bfc" id="L710" title="All 2 branches covered.">        if ( begin &lt; string.length() )</span>
        {
<span class="fc" id="L712">            replaced.append( string.substring( begin ) );</span>
        }

<span class="fc" id="L715">        return replaced.toString();</span>
    }

    /**
     * {@inheritDoc}
     */
    protected void init()
    {
<span class="fc" id="L723">        super.init();</span>

<span class="fc" id="L725">        this.sourceContent = null;</span>
<span class="fc" id="L726">        this.sink = null;</span>
<span class="fc" id="L727">        this.source = null;</span>
<span class="fc" id="L728">        this.block = null;</span>
<span class="fc" id="L729">        this.blockFileName = null;</span>
<span class="fc" id="L730">        this.blockLineNumber = 0;</span>
<span class="fc" id="L731">        this.line = null;</span>
<span class="fc" id="L732">        this.warnMessages = null;</span>
<span class="fc" id="L733">    }</span>

    // ----------------------------------------------------------------------
    // Private methods
    // ----------------------------------------------------------------------

    /**
     * Parse the head of the Apt source document.
     *
     * @throws AptParseException if something goes wrong.
     */
    private void traverseHead()
        throws AptParseException
    {
<span class="fc" id="L747">        sink.head();</span>

<span class="pc bpc" id="L749" title="1 of 4 branches missed.">        if ( block != null &amp;&amp; block.getType() == TITLE )</span>
        {
<span class="fc" id="L751">            block.traverse();</span>
<span class="fc" id="L752">            nextBlock();</span>
        }

<span class="fc" id="L755">        sink.head_();</span>
<span class="fc" id="L756">    }</span>

    /**
     * Parse the body of the Apt source document.
     *
     * @throws AptParseException if something goes wrong.
     */
    private void traverseBody()
        throws AptParseException
    {
<span class="fc" id="L766">        sink.body();</span>

<span class="pc bpc" id="L768" title="1 of 2 branches missed.">        if ( block != null )</span>
        {
<span class="fc" id="L770">            traverseSectionBlocks();</span>
        }

<span class="fc bfc" id="L773" title="All 2 branches covered.">        while ( block != null )</span>
        {
<span class="fc" id="L775">            traverseSection( 0 );</span>
        }

<span class="fc" id="L778">        sink.body_();</span>
<span class="fc" id="L779">    }</span>

    /**
     * Parse a section of the Apt source document.
     *
     * @param level The section level.
     * @throws AptParseException if something goes wrong.
     */
    private void traverseSection( int level )
        throws AptParseException
    {
<span class="pc bpc" id="L790" title="1 of 2 branches missed.">        if ( block == null )</span>
        {
<span class="nc" id="L792">            return;</span>
        }

<span class="fc" id="L795">        int type = SECTION1 + level;</span>

<span class="fc" id="L797">        expectedBlock( type );</span>

<span class="pc bpc" id="L799" title="1 of 6 branches missed.">        switch ( level )</span>
        {
            case 0:
<span class="fc" id="L802">                sink.section1();</span>
<span class="fc" id="L803">                break;</span>
            case 1:
<span class="fc" id="L805">                sink.section2();</span>
<span class="fc" id="L806">                break;</span>
            case 2:
<span class="fc" id="L808">                sink.section3();</span>
<span class="fc" id="L809">                break;</span>
            case 3:
<span class="fc" id="L811">                sink.section4();</span>
<span class="fc" id="L812">                break;</span>
            case 4:
<span class="fc" id="L814">                sink.section5();</span>
<span class="fc" id="L815">                break;</span>
            default:
                break;
        }

<span class="fc" id="L820">        block.traverse();</span>

<span class="fc" id="L822">        nextBlock();</span>

<span class="fc" id="L824">        traverseSectionBlocks();</span>

<span class="fc bfc" id="L826" title="All 2 branches covered.">        while ( block != null )</span>
        {
<span class="fc bfc" id="L828" title="All 2 branches covered.">            if ( block.getType() &lt;= type )</span>
            {
<span class="fc" id="L830">                break;</span>
            }

<span class="fc" id="L833">            traverseSection( level + 1 );</span>
        }

<span class="pc bpc" id="L836" title="1 of 6 branches missed.">        switch ( level )</span>
        {
            case 0:
<span class="fc" id="L839">                sink.section1_();</span>
<span class="fc" id="L840">                break;</span>
            case 1:
<span class="fc" id="L842">                sink.section2_();</span>
<span class="fc" id="L843">                break;</span>
            case 2:
<span class="fc" id="L845">                sink.section3_();</span>
<span class="fc" id="L846">                break;</span>
            case 3:
<span class="fc" id="L848">                sink.section4_();</span>
<span class="fc" id="L849">                break;</span>
            case 4:
<span class="fc" id="L851">                sink.section5_();</span>
<span class="fc" id="L852">                break;</span>
            default:
                break;
        }
<span class="fc" id="L856">    }</span>

    /**
     * Parse the section blocks of the Apt source document.
     *
     * @throws AptParseException if something goes wrong.
     */
    private void traverseSectionBlocks()
        throws AptParseException
    {
<span class="fc bfc" id="L866" title="All 2 branches covered.">        loop: while ( block != null )</span>
        {
<span class="pc bpc" id="L868" title="1 of 6 branches missed.">            switch ( block.getType() )</span>
            {
                case PARAGRAPH:
                case VERBATIM:
                case FIGURE:
                case TABLE:
                case HORIZONTAL_RULE:
                case PG_BREAK:
                case MACRO:
                case COMMENT_BLOCK:
<span class="fc" id="L878">                    block.traverse();</span>
<span class="fc" id="L879">                    nextBlock();</span>
<span class="fc" id="L880">                    break;</span>

                case LIST_ITEM:
<span class="fc" id="L883">                    traverseList();</span>
<span class="fc" id="L884">                    break;</span>

                case NUMBERED_LIST_ITEM:
<span class="fc" id="L887">                    traverseNumberedList();</span>
<span class="fc" id="L888">                    break;</span>

                case DEFINITION_LIST_ITEM:
<span class="fc" id="L891">                    traverseDefinitionList();</span>
<span class="fc" id="L892">                    break;</span>

                case LIST_BREAK:
                    // May be this is a list break which has not been indented
                    // very precisely.
<span class="nc" id="L897">                    nextBlock();</span>
<span class="nc" id="L898">                    break;</span>

                default:
                    // A section block which starts a new section.
<span class="fc" id="L902">                    break loop;</span>
            }
        }
<span class="fc" id="L905">    }</span>

    /**
     * Parse a list of the Apt source document.
     *
     * @throws AptParseException if something goes wrong.
     */
    private void traverseList()
        throws AptParseException
    {
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">        if ( block == null )</span>
        {
<span class="nc" id="L917">            return;</span>
        }

<span class="fc" id="L920">        expectedBlock( LIST_ITEM );</span>

<span class="fc" id="L922">        int listIndent = block.getIndent();</span>

<span class="fc" id="L924">        sink.list();</span>

<span class="fc" id="L926">        sink.listItem();</span>

<span class="fc" id="L928">        block.traverse();</span>

<span class="fc" id="L930">        nextBlock();</span>

<span class="fc bfc" id="L932" title="All 2 branches covered.">        loop: while ( block != null )</span>
        {
<span class="fc" id="L934">            int blockIndent = block.getIndent();</span>

<span class="pc bpc" id="L936" title="3 of 7 branches missed.">            switch ( block.getType() )</span>
            {
                case PARAGRAPH:
<span class="pc bpc" id="L939" title="1 of 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L941">                        break loop;</span>
                    }
                    /*FALLTHROUGH*/
                case VERBATIM:
                case MACRO:
                case FIGURE:
                case TABLE:
                case HORIZONTAL_RULE:
                case PG_BREAK:
<span class="fc" id="L950">                    block.traverse();</span>
<span class="fc" id="L951">                    nextBlock();</span>
<span class="fc" id="L952">                    break;</span>

                case LIST_ITEM:
<span class="fc bfc" id="L955" title="All 2 branches covered.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="fc" id="L957">                        break loop;</span>
                    }

<span class="fc bfc" id="L960" title="All 2 branches covered.">                    if ( blockIndent &gt; listIndent )</span>
                    {
<span class="fc" id="L962">                        traverseList();</span>
                    }
                    else
                    {
<span class="fc" id="L966">                        sink.listItem_();</span>
<span class="fc" id="L967">                        sink.listItem();</span>
<span class="fc" id="L968">                        block.traverse();</span>
<span class="fc" id="L969">                        nextBlock();</span>
                    }
<span class="fc" id="L971">                    break;</span>

                case NUMBERED_LIST_ITEM:
<span class="nc bnc" id="L974" title="All 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L976">                        break loop;</span>
                    }

<span class="nc" id="L979">                    traverseNumberedList();</span>
<span class="nc" id="L980">                    break;</span>

                case DEFINITION_LIST_ITEM:
<span class="nc bnc" id="L983" title="All 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L985">                        break loop;</span>
                    }

<span class="nc" id="L988">                    traverseDefinitionList();</span>
<span class="nc" id="L989">                    break;</span>

                case LIST_BREAK:
<span class="pc bpc" id="L992" title="1 of 2 branches missed.">                    if ( blockIndent &gt;= listIndent )</span>
                    {
<span class="fc" id="L994">                        nextBlock();</span>
                    }
                    /*FALLTHROUGH*/
                default:
                    // A block which ends the list.
<span class="fc" id="L999">                    break loop;</span>
            }
<span class="fc" id="L1001">        }</span>

<span class="fc" id="L1003">        sink.listItem_();</span>
<span class="fc" id="L1004">        sink.list_();</span>
<span class="fc" id="L1005">    }</span>

    /**
     * Parse a numbered list of the Apt source document.
     *
     * @throws AptParseException if something goes wrong.
     */
    private void traverseNumberedList()
        throws AptParseException
    {
<span class="pc bpc" id="L1015" title="1 of 2 branches missed.">        if ( block == null )</span>
        {
<span class="nc" id="L1017">            return;</span>
        }
<span class="fc" id="L1019">        expectedBlock( NUMBERED_LIST_ITEM );</span>
<span class="fc" id="L1020">        int listIndent = block.getIndent();</span>

<span class="fc" id="L1022">        sink.numberedList( ( (NumberedListItem) block ).getNumbering() );</span>
<span class="fc" id="L1023">        sink.numberedListItem();</span>
<span class="fc" id="L1024">        block.traverse();</span>
<span class="fc" id="L1025">        nextBlock();</span>

<span class="pc bpc" id="L1027" title="1 of 2 branches missed.">        loop: while ( block != null )</span>
        {
<span class="fc" id="L1029">            int blockIndent = block.getIndent();</span>

<span class="pc bpc" id="L1031" title="4 of 7 branches missed.">            switch ( block.getType() )</span>
            {
                case PARAGRAPH:
<span class="pc bpc" id="L1034" title="1 of 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="fc" id="L1036">                        break loop;</span>
                    }
                    /*FALLTHROUGH*/
                case VERBATIM:
                case FIGURE:
                case TABLE:
                case HORIZONTAL_RULE:
                case PG_BREAK:
<span class="nc" id="L1044">                    block.traverse();</span>
<span class="nc" id="L1045">                    nextBlock();</span>
<span class="nc" id="L1046">                    break;</span>

                case LIST_ITEM:
<span class="nc bnc" id="L1049" title="All 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L1051">                        break loop;</span>
                    }

<span class="nc" id="L1054">                    traverseList();</span>
<span class="nc" id="L1055">                    break;</span>

                case NUMBERED_LIST_ITEM:
<span class="fc bfc" id="L1058" title="All 2 branches covered.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="fc" id="L1060">                        break loop;</span>
                    }

<span class="fc bfc" id="L1063" title="All 2 branches covered.">                    if ( blockIndent &gt; listIndent )</span>
                    {
<span class="fc" id="L1065">                        traverseNumberedList();</span>
                    }
                    else
                    {
<span class="fc" id="L1069">                        sink.numberedListItem_();</span>
<span class="fc" id="L1070">                        sink.numberedListItem();</span>
<span class="fc" id="L1071">                        block.traverse();</span>
<span class="fc" id="L1072">                        nextBlock();</span>
                    }
<span class="fc" id="L1074">                    break;</span>

                case DEFINITION_LIST_ITEM:
<span class="nc bnc" id="L1077" title="All 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L1079">                        break loop;</span>
                    }

<span class="nc" id="L1082">                    traverseDefinitionList();</span>
<span class="nc" id="L1083">                    break;</span>

                case LIST_BREAK:
<span class="pc bpc" id="L1086" title="1 of 2 branches missed.">                    if ( blockIndent &gt;= listIndent )</span>
                    {
<span class="fc" id="L1088">                        nextBlock();</span>
                    }
                    /*FALLTHROUGH*/
                default:
                    // A block which ends the list.
<span class="fc" id="L1093">                    break loop;</span>
            }
<span class="fc" id="L1095">        }</span>

<span class="fc" id="L1097">        sink.numberedListItem_();</span>
<span class="fc" id="L1098">        sink.numberedList_();</span>
<span class="fc" id="L1099">    }</span>

    /**
     * Parse a definition list of the Apt source document.
     *
     * @throws AptParseException if something goes wrong.
     */
    private void traverseDefinitionList()
        throws AptParseException
    {
<span class="pc bpc" id="L1109" title="1 of 2 branches missed.">        if ( block == null )</span>
        {
<span class="nc" id="L1111">            return;</span>
        }
<span class="fc" id="L1113">        expectedBlock( DEFINITION_LIST_ITEM );</span>
<span class="fc" id="L1114">        int listIndent = block.getIndent();</span>

<span class="fc" id="L1116">        sink.definitionList();</span>
<span class="fc" id="L1117">        sink.definitionListItem();</span>
<span class="fc" id="L1118">        block.traverse();</span>
<span class="fc" id="L1119">        nextBlock();</span>

<span class="pc bpc" id="L1121" title="1 of 2 branches missed.">        loop: while ( block != null )</span>
        {
<span class="fc" id="L1123">            int blockIndent = block.getIndent();</span>

<span class="pc bpc" id="L1125" title="3 of 7 branches missed.">            switch ( block.getType() )</span>
            {
                case PARAGRAPH:
<span class="pc bpc" id="L1128" title="1 of 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="fc" id="L1130">                        break loop;</span>
                    }
                    /*FALLTHROUGH*/
                case VERBATIM:
                case FIGURE:
                case TABLE:
                case HORIZONTAL_RULE:
                case PG_BREAK:
<span class="fc" id="L1138">                    block.traverse();</span>
<span class="fc" id="L1139">                    nextBlock();</span>
<span class="fc" id="L1140">                    break;</span>

                case LIST_ITEM:
<span class="nc bnc" id="L1143" title="All 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L1145">                        break loop;</span>
                    }

<span class="nc" id="L1148">                    traverseList();</span>
<span class="nc" id="L1149">                    break;</span>

                case NUMBERED_LIST_ITEM:
<span class="nc bnc" id="L1152" title="All 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L1154">                        break loop;</span>
                    }

<span class="nc" id="L1157">                    traverseNumberedList();</span>
<span class="nc" id="L1158">                    break;</span>

                case DEFINITION_LIST_ITEM:
<span class="pc bpc" id="L1161" title="1 of 2 branches missed.">                    if ( blockIndent &lt; listIndent )</span>
                    {
<span class="nc" id="L1163">                        break loop;</span>
                    }

<span class="pc bpc" id="L1166" title="1 of 2 branches missed.">                    if ( blockIndent &gt; listIndent )</span>
                    {
<span class="nc" id="L1168">                        traverseDefinitionList();</span>
                    }
                    else
                    {
<span class="fc" id="L1172">                        sink.definition_();</span>
<span class="fc" id="L1173">                        sink.definitionListItem_();</span>
<span class="fc" id="L1174">                        sink.definitionListItem();</span>
<span class="fc" id="L1175">                        block.traverse();</span>
<span class="fc" id="L1176">                        nextBlock();</span>
                    }
<span class="fc" id="L1178">                    break;</span>

                case LIST_BREAK:
<span class="pc bpc" id="L1181" title="1 of 2 branches missed.">                    if ( blockIndent &gt;= listIndent )</span>
                    {
<span class="fc" id="L1183">                        nextBlock();</span>
                    }
                    /*FALLTHROUGH*/
                default:
                    // A block which ends the list.
<span class="fc" id="L1188">                    break loop;</span>
            }
<span class="fc" id="L1190">        }</span>

<span class="fc" id="L1192">        sink.definition_();</span>
<span class="fc" id="L1193">        sink.definitionListItem_();</span>
<span class="fc" id="L1194">        sink.definitionList_();</span>
<span class="fc" id="L1195">    }</span>

    /**
     * Parse the next block of the Apt source document.
     *
     * @throws AptParseException if something goes wrong.
     */
    private void nextBlock()
        throws AptParseException
    {
<span class="fc" id="L1205">        nextBlock( /*first*/false );</span>
<span class="fc" id="L1206">    }</span>

    /**
     * Parse the next block of the Apt source document.
     *
     * @param firstBlock True if this is the first block of the Apt source document.
     * @throws AptParseException if something goes wrong.
     */
    private void nextBlock( boolean firstBlock )
        throws AptParseException
    {
        // Skip open lines.
        int length, indent, i;

        skipLoop: for ( ;; )
        {
<span class="fc bfc" id="L1222" title="All 2 branches covered.">            if ( line == null )</span>
            {
<span class="fc" id="L1224">                block = null;</span>
<span class="fc" id="L1225">                return;</span>
            }

<span class="fc" id="L1228">            length = line.length();</span>
<span class="fc" id="L1229">            indent = 0;</span>
<span class="fc bfc" id="L1230" title="All 2 branches covered.">            for ( i = 0; i &lt; length; ++i )</span>
            {
<span class="pc bpc" id="L1232" title="1 of 3 branches missed.">                switch ( line.charAt( i ) )</span>
                {
                    case SPACE:
<span class="fc" id="L1235">                        ++indent;</span>
<span class="fc" id="L1236">                        break;</span>
                    case TAB:
<span class="nc" id="L1238">                        indent += 8;</span>
<span class="nc" id="L1239">                        break;</span>
                    default:
<span class="fc" id="L1241">                        break skipLoop;</span>
                }
            }

<span class="pc bpc" id="L1245" title="1 of 2 branches missed.">            if ( i == length )</span>
            {
<span class="fc" id="L1247">                nextLine();</span>
            }
        }

<span class="fc" id="L1251">        blockFileName = source.getName();</span>
<span class="fc" id="L1252">        blockLineNumber = source.getLineNumber();</span>
<span class="fc" id="L1253">        block = null;</span>
<span class="fc bfc" id="L1254" title="All 9 branches covered.">        switch ( line.charAt( i ) )</span>
        {
            case STAR:
<span class="fc bfc" id="L1257" title="All 2 branches covered.">                if ( indent == 0 )</span>
                {
<span class="pc bpc" id="L1259" title="1 of 4 branches missed.">                    if ( charAt( line, length, i + 1 ) == MINUS &amp;&amp; charAt( line, length, i + 2 ) == MINUS )</span>
                    {
<span class="fc" id="L1261">                        block = new Table( indent, line );</span>
                    }
<span class="fc bfc" id="L1263" title="All 2 branches covered.">                    else if ( charAt( line, length, i + 1 ) == STAR )</span>
                    {
<span class="fc bfc" id="L1265" title="All 2 branches covered.">                        if ( charAt( line, length, i + 2 ) == STAR )</span>
                        {
<span class="fc bfc" id="L1267" title="All 2 branches covered.">                            if ( charAt( line, length, i + 3 ) == STAR )</span>
                            {
<span class="fc" id="L1269">                                block = new Section5( indent, line );</span>
                            }
                            else
                            {
<span class="fc" id="L1273">                                block = new Section4( indent, line );</span>
                            }
                        }
                        else
                        {
<span class="fc" id="L1278">                            block = new Section3( indent, line );</span>
                        }
                    }
                    else
                    {
<span class="fc" id="L1283">                        block = new Section2( indent, line );</span>
                    }
                }
                else
                {
<span class="fc" id="L1288">                    block = new ListItem( indent, line );</span>
                }
<span class="fc" id="L1290">                break;</span>
            case LEFT_SQUARE_BRACKET:
<span class="fc bfc" id="L1292" title="All 2 branches covered.">                if ( charAt( line, length, i + 1 ) == RIGHT_SQUARE_BRACKET )</span>
                {
<span class="fc" id="L1294">                    block = new ListBreak( indent, line );</span>
                }
                else
                {
<span class="fc bfc" id="L1298" title="All 2 branches covered.">                    if ( indent == 0 )</span>
                    {
<span class="fc" id="L1300">                        block = new Figure( indent, line );</span>
                    }
                    else
                    {
<span class="fc bfc" id="L1304" title="All 2 branches covered.">                        if ( charAt( line, length, i + 1 ) == LEFT_SQUARE_BRACKET )</span>
                        {
                            int numbering;

<span class="pc bpc" id="L1308" title="3 of 5 branches missed.">                            switch ( charAt( line, length, i + 2 ) )</span>
                            {
                                case NUMBERING_LOWER_ALPHA_CHAR:
<span class="nc" id="L1311">                                    numbering = Sink.NUMBERING_LOWER_ALPHA;</span>
<span class="nc" id="L1312">                                    break;</span>
                                case NUMBERING_UPPER_ALPHA_CHAR:
<span class="fc" id="L1314">                                    numbering = Sink.NUMBERING_UPPER_ALPHA;</span>
<span class="fc" id="L1315">                                    break;</span>
                                case NUMBERING_LOWER_ROMAN_CHAR:
<span class="nc" id="L1317">                                    numbering = Sink.NUMBERING_LOWER_ROMAN;</span>
<span class="nc" id="L1318">                                    break;</span>
                                case NUMBERING_UPPER_ROMAN_CHAR:
<span class="nc" id="L1320">                                    numbering = Sink.NUMBERING_UPPER_ROMAN;</span>
<span class="nc" id="L1321">                                    break;</span>
                                case NUMBERING:
                                default:
                                    // The first item establishes the numbering
                                    // scheme for the whole list.
<span class="fc" id="L1326">                                    numbering = Sink.NUMBERING_DECIMAL;</span>
                            }

<span class="fc" id="L1329">                            block = new NumberedListItem( indent, line, numbering );</span>
<span class="fc" id="L1330">                        }</span>
                        else
                        {
<span class="fc" id="L1333">                            block = new DefinitionListItem( indent, line );</span>
                        }
                    }
                }
<span class="fc" id="L1337">                break;</span>
            case MINUS:
<span class="pc bpc" id="L1339" title="2 of 4 branches missed.">                if ( charAt( line, length, i + 1 ) == MINUS &amp;&amp; charAt( line, length, i + 2 ) == MINUS )</span>
                {
<span class="fc bfc" id="L1341" title="All 2 branches covered.">                    if ( indent == 0 )</span>
                    {
<span class="fc" id="L1343">                        block = new Verbatim( indent, line );</span>
                    }
                    else
                    {
<span class="fc bfc" id="L1347" title="All 2 branches covered.">                        if ( firstBlock )</span>
                        {
<span class="fc" id="L1349">                            block = new Title( indent, line );</span>
                        }
                    }
                }
                break;
            case PLUS:
<span class="pc bpc" id="L1355" title="3 of 6 branches missed.">                if ( indent == 0 &amp;&amp; charAt( line, length, i + 1 ) == MINUS &amp;&amp; charAt( line, length, i + 2 ) == MINUS )</span>
                {
<span class="fc" id="L1357">                    block = new Verbatim( indent, line );</span>
                }
                break;
            case EQUAL:
<span class="pc bpc" id="L1361" title="3 of 6 branches missed.">                if ( indent == 0 &amp;&amp; charAt( line, length, i + 1 ) == EQUAL &amp;&amp; charAt( line, length, i + 2 ) == EQUAL )</span>
                {
<span class="fc" id="L1363">                    block = new HorizontalRule( indent, line );</span>
                }
                break;
            case PAGE_BREAK:
<span class="pc bpc" id="L1367" title="1 of 2 branches missed.">                if ( indent == 0 )</span>
                {
<span class="fc" id="L1369">                    block = new PageBreak( indent, line );</span>
                }
                break;
            case PERCENT:
<span class="pc bpc" id="L1373" title="2 of 4 branches missed.">                if ( indent == 0 &amp;&amp; charAt( line, length, i + 1 ) == LEFT_CURLY_BRACKET )</span>
                {
<span class="fc" id="L1375">                    block = new MacroBlock( indent, line );</span>
                }
                break;
            case COMMENT:
<span class="pc bpc" id="L1379" title="1 of 2 branches missed.">                if ( charAt( line, length, i + 1 ) == COMMENT )</span>
                {
<span class="fc" id="L1381">                    block = new Comment( line.substring( i + 2 ) );</span>
                }
                break;
            default:
                break;
        }

<span class="fc bfc" id="L1388" title="All 2 branches covered.">        if ( block == null )</span>
        {
<span class="fc bfc" id="L1390" title="All 2 branches covered.">            if ( indent == 0 )</span>
            {
<span class="fc" id="L1392">                block = new Section1( indent, line );</span>
            }
            else
            {
<span class="fc" id="L1396">                block = new Paragraph( indent, line );</span>
            }
        }
<span class="fc" id="L1399">    }</span>

    /**
     * Checks that the current block is of the expected type.
     *
     * @param type the expected type.
     * @throws AptParseException if something goes wrong.
     */
    private void expectedBlock( int type )
        throws AptParseException
    {
<span class="fc" id="L1410">        int blockType = block.getType();</span>

<span class="pc bpc" id="L1412" title="1 of 2 branches missed.">        if ( blockType != type )</span>
        {
<span class="nc" id="L1414">            throw new AptParseException( &quot;expected &quot; + TYPE_NAMES[type] + &quot;, found &quot; + TYPE_NAMES[blockType] );</span>
        }
<span class="fc" id="L1416">    }</span>

    // -----------------------------------------------------------------------

    /**
     * Determine if c is an octal character.
     *
     * @param c the character.
     * @return boolean
     */
    private static boolean isOctalChar( char c )
    {
<span class="pc bpc" id="L1428" title="2 of 4 branches missed.">        return ( c &gt;= '0' &amp;&amp; c &lt;= '7' );</span>
    }

    /**
     * Determine if c is an hex character.
     *
     * @param c the character.
     * @return boolean
     */
    private static boolean isHexChar( char c )
    {
<span class="pc bpc" id="L1439" title="4 of 12 branches missed.">        return ( ( c &gt;= '0' &amp;&amp; c &lt;= '9' ) || ( c &gt;= 'a' &amp;&amp; c &lt;= 'f' ) || ( c &gt;= 'A' &amp;&amp; c &lt;= 'F' ) );</span>
    }

    /**
     * Emits the text so far parsed into the given sink.
     *
     * @param buffer A StringBuilder that contains the text to be flushed.
     * @param sink The sink to receive the text.
     */
    private static void flushTraversed( StringBuilder buffer, Sink sink )
    {
<span class="fc bfc" id="L1450" title="All 2 branches covered.">        if ( buffer.length() &gt; 0 )</span>
        {
<span class="fc" id="L1452">            sink.text( buffer.toString() );</span>
<span class="fc" id="L1453">            buffer.setLength( 0 );</span>
        }
<span class="fc" id="L1455">    }</span>

    /**
     * Parse the given text.
     *
     * @param text the text to parse.
     * @param begin offset.
     * @param end offset.
     * @param linkAnchor a StringBuilder.
     * @return int
     * @throws AptParseException if something goes wrong.
     */
    private static int skipTraversedLinkAnchor( String text, int begin, int end, StringBuilder linkAnchor )
        throws AptParseException
    {
        int i;
<span class="pc bpc" id="L1471" title="1 of 2 branches missed.">        loop: for ( i = begin; i &lt; end; ++i )</span>
        {
<span class="fc" id="L1473">            char c = text.charAt( i );</span>
<span class="pc bpc" id="L1474" title="1 of 3 branches missed.">            switch ( c )</span>
            {
                case RIGHT_CURLY_BRACKET:
<span class="fc" id="L1477">                    break loop;</span>
                case BACKSLASH:
<span class="nc bnc" id="L1479" title="All 2 branches missed.">                    if ( i + 1 &lt; end )</span>
                    {
<span class="nc" id="L1481">                        ++i;</span>
<span class="nc" id="L1482">                        linkAnchor.append( text.charAt( i ) );</span>
                    }
                    else
                    {
<span class="nc" id="L1486">                        linkAnchor.append( BACKSLASH );</span>
                    }
<span class="nc" id="L1488">                    break;</span>
                default:
<span class="fc" id="L1490">                    linkAnchor.append( c );</span>
            }
        }
<span class="pc bpc" id="L1493" title="1 of 2 branches missed.">        if ( i == end )</span>
        {
<span class="nc" id="L1495">            throw new AptParseException( &quot;missing '&quot; + RIGHT_CURLY_BRACKET + &quot;'&quot; );</span>
        }

<span class="fc" id="L1498">        return i;</span>
    }

    /**
     * Parse the given text.
     *
     * @param text the text to parse.
     * @param begin offset.
     * @param end offset.
     * @return String
     * @throws AptParseException if something goes wrong.
     */
    private String getTraversedLink( String text, int begin, int end )
        throws AptParseException
    {
<span class="fc" id="L1513">        char previous2 = LEFT_CURLY_BRACKET;</span>
<span class="fc" id="L1514">        char previous = LEFT_CURLY_BRACKET;</span>
        int i;

<span class="pc bpc" id="L1517" title="1 of 2 branches missed.">        for ( i = begin; i &lt; end; ++i )</span>
        {
<span class="fc" id="L1519">            char c = text.charAt( i );</span>
<span class="pc bpc" id="L1520" title="1 of 6 branches missed.">            if ( c == RIGHT_CURLY_BRACKET &amp;&amp; previous == RIGHT_CURLY_BRACKET &amp;&amp; previous2 != BACKSLASH )</span>
            {
<span class="fc" id="L1522">                break;</span>
            }

<span class="fc" id="L1525">            previous2 = previous;</span>
<span class="fc" id="L1526">            previous = c;</span>
        }
<span class="pc bpc" id="L1528" title="1 of 2 branches missed.">        if ( i == end )</span>
        {
<span class="nc" id="L1530">            throw new AptParseException( &quot;missing '&quot; + LEFT_CURLY_BRACKET + LEFT_CURLY_BRACKET + &quot;'&quot; );</span>
        }

<span class="fc" id="L1533">        return doGetTraversedLink( text, begin, i - 1 );</span>
    }

    /**
     * Parse the given text.
     *
     * @param text the text to parse.
     * @param begin offset.
     * @param end offset.
     * @return String
     * @throws AptParseException if something goes wrong.
     */
    private String getTraversedAnchor( String text, int begin, int end )
        throws AptParseException
    {
<span class="fc" id="L1548">        char previous = LEFT_CURLY_BRACKET;</span>
        int i;

<span class="pc bpc" id="L1551" title="1 of 2 branches missed.">        for ( i = begin; i &lt; end; ++i )</span>
        {
<span class="fc" id="L1553">            char c = text.charAt( i );</span>
<span class="pc bpc" id="L1554" title="1 of 4 branches missed.">            if ( c == RIGHT_CURLY_BRACKET &amp;&amp; previous != BACKSLASH )</span>
            {
<span class="fc" id="L1556">                break;</span>
            }

<span class="fc" id="L1559">            previous = c;</span>
        }
<span class="pc bpc" id="L1561" title="1 of 2 branches missed.">        if ( i == end )</span>
        {
<span class="nc" id="L1563">            throw new AptParseException( &quot;missing '&quot; + RIGHT_CURLY_BRACKET + &quot;'&quot; );</span>
        }

<span class="fc" id="L1566">        return doGetTraversedLink( text, begin, i );</span>
    }

    /**
     * Parse the given text.
     *
     * @param text the text to parse.
     * @param begin offset.
     * @param end offset.
     * @return String
     * @throws AptParseException if something goes wrong.
     */
    private String doGetTraversedLink( String text, int begin, int end )
        throws AptParseException
    {
<span class="fc" id="L1581">        final StringBuilder buffer = new StringBuilder( end - begin );</span>

<span class="fc" id="L1583">        Sink linkSink = new SinkAdapter()</span>
<span class="fc" id="L1584">        {</span>
            /** {@inheritDoc} */
            public void lineBreak()
            {
<span class="nc" id="L1588">                buffer.append( SPACE );</span>
<span class="nc" id="L1589">            }</span>

            /** {@inheritDoc} */
            public void nonBreakingSpace()
            {
<span class="nc" id="L1594">                buffer.append( SPACE );</span>
<span class="nc" id="L1595">            }</span>

            /** {@inheritDoc} */
            public void text( String text )
            {
<span class="fc" id="L1600">                buffer.append( text );</span>
<span class="fc" id="L1601">            }</span>
        };
<span class="fc" id="L1603">        doTraverseText( text, begin, end, linkSink );</span>

<span class="fc" id="L1605">        return buffer.toString().trim();</span>
    }

    /**
     * If debug mode is enabled, log the &lt;code&gt;msg&lt;/code&gt; as is, otherwise add unique msg in &lt;code&gt;warnMessages&lt;/code&gt;.
     *
     * @param key not null
     * @param msg not null
     * @see #parse(Reader, Sink)
     * @since 1.1.1
     */
    private void logMessage( String key, String msg )
    {
<span class="fc" id="L1618">        msg = &quot;[APT Parser] &quot; + msg;</span>
<span class="pc bpc" id="L1619" title="1 of 2 branches missed.">        if ( getLog().isDebugEnabled() )</span>
        {
<span class="nc" id="L1621">            getLog().debug( msg );</span>

<span class="nc" id="L1623">            return;</span>
        }

<span class="pc bpc" id="L1626" title="1 of 2 branches missed.">        if ( warnMessages == null )</span>
        {
<span class="fc" id="L1628">            warnMessages = new HashMap&lt;&gt;();</span>
        }

<span class="fc" id="L1631">        Set&lt;String&gt; set = warnMessages.get( key );</span>
<span class="pc bpc" id="L1632" title="1 of 2 branches missed.">        if ( set == null )</span>
        {
<span class="fc" id="L1634">            set = new TreeSet&lt;&gt;();</span>
        }
<span class="fc" id="L1636">        set.add( msg );</span>
<span class="fc" id="L1637">        warnMessages.put( key, set );</span>
<span class="fc" id="L1638">    }</span>

    /**
     * @since 1.1.2
     */
    private void logWarnings()
    {
<span class="pc bpc" id="L1645" title="2 of 6 branches missed.">        if ( getLog().isWarnEnabled() &amp;&amp; this.warnMessages != null &amp;&amp; !isSecondParsing() )</span>
        {
<span class="fc bfc" id="L1647" title="All 2 branches covered.">            for ( Map.Entry&lt;String, Set&lt;String&gt;&gt; entry : this.warnMessages.entrySet() )</span>
            {
<span class="fc bfc" id="L1649" title="All 2 branches covered.">                for ( String msg : entry.getValue() )</span>
                {
<span class="fc" id="L1651">                    getLog().warn( msg );</span>
<span class="fc" id="L1652">                }</span>
<span class="fc" id="L1653">            }</span>

<span class="fc" id="L1655">            this.warnMessages = null;</span>
        }
<span class="fc" id="L1657">    }</span>

    // -----------------------------------------------------------------------

    /** A block of an apt source document. */
    private abstract class Block
    {
        /** type. */
        protected int type;

        /** indent. */
        protected int indent;

        /** text. */
        protected String text;

        /** textLength. */
        protected int textLength;

        /**
         * Constructor.
         *
         * @param type the block type.
         * @param indent indent.
         * @throws AptParseException AptParseException
         */
        Block( int type, int indent )
            throws AptParseException
        {
<span class="fc" id="L1686">            this( type, indent, null );</span>
<span class="fc" id="L1687">        }</span>

        /**
         * Constructor.
         *
         * @param type type.
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Block( int type, int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L1699">        {</span>
<span class="fc" id="L1700">            this.type = type;</span>
<span class="fc" id="L1701">            this.indent = indent;</span>

            // Skip first line ---
<span class="fc" id="L1704">            AptParser.this.nextLine();</span>

<span class="fc bfc" id="L1706" title="All 2 branches covered.">            if ( firstLine == null )</span>
            {
<span class="fc" id="L1708">                text = null;</span>
<span class="fc" id="L1709">                textLength = 0;</span>
            }
            else
            {
                // Read block ---
<span class="fc" id="L1714">                StringBuilder buffer = new StringBuilder( firstLine );</span>

<span class="fc bfc" id="L1716" title="All 2 branches covered.">                while ( AptParser.this.line != null )</span>
                {
<span class="fc" id="L1718">                    String l = AptParser.this.line;</span>
<span class="fc" id="L1719">                    int length = l.length();</span>
<span class="fc" id="L1720">                    int i = 0;</span>

<span class="fc" id="L1722">                    i = skipSpace( l, length, i );</span>
<span class="fc bfc" id="L1723" title="All 2 branches covered.">                    if ( i == length )</span>
                    {
                        // Stop after open line and skip it.
<span class="fc" id="L1726">                        AptParser.this.nextLine();</span>
<span class="fc" id="L1727">                        break;</span>
                    }
<span class="fc bfc" id="L1729" title="All 2 branches covered.">                    else if ( ( AptParser.charAt( l, length, i ) == COMMENT</span>
<span class="pc bpc" id="L1730" title="1 of 4 branches missed.">                            &amp;&amp; AptParser.charAt( l, length, i + 1 ) == COMMENT )</span>
                            || type == COMMENT_BLOCK )
                    {
                        // parse comments as separate blocks line by line
<span class="fc" id="L1734">                        break;</span>
                    }

<span class="fc" id="L1737">                    buffer.append( EOL );</span>
<span class="fc" id="L1738">                    buffer.append( l );</span>

<span class="fc" id="L1740">                    AptParser.this.nextLine();</span>
<span class="fc" id="L1741">                }</span>

<span class="fc" id="L1743">                text = buffer.toString();</span>
<span class="fc" id="L1744">                textLength = text.length();</span>
            }
<span class="fc" id="L1746">        }</span>

        /**
         * Return the block type.
         *
         * @return int
         */
        public final int getType()
        {
<span class="fc" id="L1755">            return type;</span>
        }

        /**
         * Return the block indent.
         *
         * @return int
         */
        public final int getIndent()
        {
<span class="fc" id="L1765">            return indent;</span>
        }

        /**
         * Parse the block.
         *
         * @throws AptParseException if something goes wrong.
         */
        public abstract void traverse()
            throws AptParseException;

        /**
         * Traverse the text.
         *
         * @param begin offset.
         * @throws AptParseException if something goes wrong.
         */
        protected void traverseText( int begin )
            throws AptParseException
        {
<span class="fc" id="L1785">            traverseText( begin, text.length() );</span>
<span class="fc" id="L1786">        }</span>

        /**
         * Traverse the text.
         *
         * @param begin offset.
         * @param end offset.
         * @throws AptParseException if something goes wrong.
         */
        protected void traverseText( int begin, int end )
            throws AptParseException
        {
<span class="fc" id="L1798">            AptParser.this.doTraverseText( text, begin, end, AptParser.this.sink );</span>
<span class="fc" id="L1799">        }</span>

        /**
         * Skip spaces.
         *
         * @return int.
         */
        protected int skipLeadingBullets()
        {
<span class="fc" id="L1808">            int i = skipSpaceFrom( 0 );</span>
<span class="pc bpc" id="L1809" title="1 of 2 branches missed.">            for ( ; i &lt; textLength; ++i )</span>
            {
<span class="fc bfc" id="L1811" title="All 2 branches covered.">                if ( text.charAt( i ) != STAR )</span>
                {
<span class="fc" id="L1813">                    break;</span>
                }
            }
<span class="fc" id="L1816">            return skipSpaceFrom( i );</span>
        }

        /**
         * Skip brackets.
         *
         * @param i offset.
         * @return int.
         * @throws AptParseException if something goes wrong.
         */
        protected int skipFromLeftToRightBracket( int i )
            throws AptParseException
        {
<span class="fc" id="L1829">            char previous = LEFT_SQUARE_BRACKET;</span>
<span class="pc bpc" id="L1830" title="1 of 2 branches missed.">            for ( ++i; i &lt; textLength; ++i )</span>
            {
<span class="fc" id="L1832">                char c = text.charAt( i );</span>
<span class="pc bpc" id="L1833" title="1 of 4 branches missed.">                if ( c == RIGHT_SQUARE_BRACKET &amp;&amp; previous != BACKSLASH )</span>
                {
<span class="fc" id="L1835">                    break;</span>
                }
<span class="fc" id="L1837">                previous = c;</span>
            }
<span class="pc bpc" id="L1839" title="1 of 2 branches missed.">            if ( i == textLength )</span>
            {
<span class="nc" id="L1841">                throw new AptParseException( &quot;missing '&quot; + RIGHT_SQUARE_BRACKET + &quot;'&quot; );</span>
            }

<span class="fc" id="L1844">            return i;</span>
        }

        /**
         * Skip spaces.
         *
         * @param i offset.
         * @return int.
         */
        protected final int skipSpaceFrom( int i )
        {
<span class="fc" id="L1855">            return AptParser.skipSpace( text, textLength, i );</span>
        }
    }

    /** A ListBreak Block. */
    private class ListBreak
        extends AptParser.Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        ListBreak( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L1872">        {</span>
<span class="fc" id="L1873">            super( AptParser.LIST_BREAK, indent, firstLine );</span>
<span class="fc" id="L1874">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="nc" id="L1880">            throw new AptParseException( &quot;internal error: traversing list break&quot; );</span>
        }
    }

    /** A Title Block. */
    private class Title
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Title( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L1897">        {</span>
<span class="fc" id="L1898">            super( TITLE, indent, firstLine );</span>
<span class="fc" id="L1899">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L1905">            StringTokenizer lines = new StringTokenizer( text, EOL );</span>
<span class="fc" id="L1906">            int separator = -1;</span>
<span class="fc" id="L1907">            boolean firstLine = true;</span>
<span class="fc" id="L1908">            boolean title = false;</span>
<span class="fc" id="L1909">            boolean author = false;</span>
<span class="fc" id="L1910">            boolean date = false;</span>

<span class="fc bfc" id="L1912" title="All 2 branches covered.">            loop: while ( lines.hasMoreTokens() )</span>
            {
<span class="fc" id="L1914">                String line = lines.nextToken().trim();</span>
<span class="fc" id="L1915">                int lineLength = line.length();</span>

<span class="fc bfc" id="L1917" title="All 2 branches covered.">                if ( AptParser.charAt( line, lineLength, 0 ) == MINUS</span>
<span class="pc bpc" id="L1918" title="1 of 2 branches missed.">                    &amp;&amp; AptParser.charAt( line, lineLength, 1 ) == MINUS</span>
<span class="pc bpc" id="L1919" title="1 of 2 branches missed.">                    &amp;&amp; AptParser.charAt( line, lineLength, 2 ) == MINUS )</span>
                {
<span class="fc bfc" id="L1921" title="All 4 branches covered.">                    switch ( separator )</span>
                    {
                        case 0:
<span class="pc bpc" id="L1924" title="1 of 2 branches missed.">                            if ( title )</span>
                            {
<span class="fc" id="L1926">                                AptParser.this.sink.title_();</span>
                            }
                            else
                            {
<span class="nc" id="L1930">                                throw new AptParseException( &quot;missing title&quot; );</span>
                            }
                            break;
                        case 1:
<span class="pc bpc" id="L1934" title="1 of 2 branches missed.">                            if ( author )</span>
                            {
<span class="fc" id="L1936">                                AptParser.this.sink.author_();</span>
                            }
                            break;
                        case 2:
                            // Note that an extra decorative line is allowed
                            // at the end of the author.
<span class="fc" id="L1942">                            break loop;</span>
                        default:
                            break;
                    }

<span class="fc" id="L1947">                    ++separator;</span>
<span class="fc" id="L1948">                    firstLine = true;</span>
                }
                else
                {
<span class="pc bpc" id="L1952" title="1 of 2 branches missed.">                    if ( firstLine )</span>
                    {
<span class="fc" id="L1954">                        firstLine = false;</span>
<span class="pc bpc" id="L1955" title="1 of 4 branches missed.">                        switch ( separator )</span>
                        {
                            case 0:
<span class="fc" id="L1958">                                title = true;</span>
<span class="fc" id="L1959">                                AptParser.this.sink.title();</span>
<span class="fc" id="L1960">                                break;</span>
                            case 1:
<span class="fc" id="L1962">                                author = true;</span>
<span class="fc" id="L1963">                                AptParser.this.sink.author();</span>
<span class="fc" id="L1964">                                break;</span>
                            case 2:
<span class="fc" id="L1966">                                date = true;</span>
<span class="fc" id="L1967">                                AptParser.this.sink.date();</span>
<span class="fc" id="L1968">                                break;</span>
                            default:
<span class="nc" id="L1970">                                break;</span>
                        }
                    }
                    else
                    {
                        // An implicit lineBreak separates title lines.
<span class="nc" id="L1976">                        AptParser.this.sink.lineBreak();</span>
                    }

<span class="fc" id="L1979">                    AptParser.this.doTraverseText( line, 0, lineLength, AptParser.this.sink );</span>
                }
<span class="fc" id="L1981">            }</span>

<span class="pc bpc" id="L1983" title="3 of 4 branches missed.">            switch ( separator )</span>
            {
                case 0:
<span class="nc bnc" id="L1986" title="All 2 branches missed.">                    if ( title )</span>
                    {
<span class="nc" id="L1988">                        AptParser.this.sink.title_();</span>
                    }
                    else
                    {
<span class="nc" id="L1992">                        throw new AptParseException( &quot;missing title&quot; );</span>
                    }
                    break;
                case 1:
<span class="nc bnc" id="L1996" title="All 2 branches missed.">                    if ( author )</span>
                    {
<span class="nc" id="L1998">                        AptParser.this.sink.author_();</span>
                    }
                    break;
                case 2:
<span class="fc bfc" id="L2002" title="All 2 branches covered.">                    if ( date )</span>
                    {
<span class="fc" id="L2004">                        AptParser.this.sink.date_();</span>
                    }
                    break;
                default:
                    break;
            }
<span class="fc" id="L2010">        }</span>
    }

    /** A Section Block. */
    private abstract class Section
        extends Block
    {
        /**
         * Constructor.
         *
         * @param type type.
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Section( int type, int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2027">        {</span>
<span class="fc" id="L2028">            super( type, indent, firstLine );</span>
<span class="fc" id="L2029">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2035">            Title();</span>
<span class="fc" id="L2036">            traverseText( skipLeadingBullets() );</span>
<span class="fc" id="L2037">            Title_();</span>
<span class="fc" id="L2038">        }</span>

        /** Start a title. */
        public abstract void Title();

        /** End a title. */
        public abstract void Title_();
    }

    /** A Section1 Block. */
    private class Section1
        extends Section
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Section1( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2060">        {</span>
<span class="fc" id="L2061">            super( SECTION1, indent, firstLine );</span>
<span class="fc" id="L2062">        }</span>

        /** {@inheritDoc} */
        public void Title()
        {
<span class="fc" id="L2067">            AptParser.this.sink.sectionTitle1();</span>
<span class="fc" id="L2068">        }</span>

        /** {@inheritDoc} */
        public void Title_()
        {
<span class="fc" id="L2073">            AptParser.this.sink.sectionTitle1_();</span>
<span class="fc" id="L2074">        }</span>
    }

    /** A Section2 Block. */
    private class Section2
        extends Section
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Section2( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2090">        {</span>
<span class="fc" id="L2091">            super( SECTION2, indent, firstLine );</span>
<span class="fc" id="L2092">        }</span>

        /** {@inheritDoc} */
        public void Title()
        {
<span class="fc" id="L2097">            AptParser.this.sink.sectionTitle2();</span>
<span class="fc" id="L2098">        }</span>

        /** {@inheritDoc} */
        public void Title_()
        {
<span class="fc" id="L2103">            AptParser.this.sink.sectionTitle2_();</span>
<span class="fc" id="L2104">        }</span>
    }

    /** A Section3 Block. */
    public class Section3
        extends Section
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Section3( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2120">        {</span>
<span class="fc" id="L2121">            super( SECTION3, indent, firstLine );</span>
<span class="fc" id="L2122">        }</span>

        /** {@inheritDoc} */
        public void Title()
        {
<span class="fc" id="L2127">            AptParser.this.sink.sectionTitle3();</span>
<span class="fc" id="L2128">        }</span>

        /** {@inheritDoc} */
        public void Title_()
        {
<span class="fc" id="L2133">            AptParser.this.sink.sectionTitle3_();</span>
<span class="fc" id="L2134">        }</span>
    }

    /** A Section4 Block. */
    private class Section4
        extends Section
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Section4( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2150">        {</span>
<span class="fc" id="L2151">            super( SECTION4, indent, firstLine );</span>
<span class="fc" id="L2152">        }</span>

        /** {@inheritDoc} */
        public void Title()
        {
<span class="fc" id="L2157">            AptParser.this.sink.sectionTitle4();</span>
<span class="fc" id="L2158">        }</span>

        /** {@inheritDoc} */
        public void Title_()
        {
<span class="fc" id="L2163">            AptParser.this.sink.sectionTitle4_();</span>
<span class="fc" id="L2164">        }</span>
    }

    /** A Section5 Block. */
    private class Section5
        extends Section
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Section5( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2180">        {</span>
<span class="fc" id="L2181">            super( SECTION5, indent, firstLine );</span>
<span class="fc" id="L2182">        }</span>

        /** {@inheritDoc} */
        public void Title()
        {
<span class="fc" id="L2187">            AptParser.this.sink.sectionTitle5();</span>
<span class="fc" id="L2188">        }</span>

        /** {@inheritDoc} */
        public void Title_()
        {
<span class="fc" id="L2193">            AptParser.this.sink.sectionTitle5_();</span>
<span class="fc" id="L2194">        }</span>
    }

    /** A Paragraph Block. */
    private class Paragraph
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Paragraph( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2210">        {</span>
<span class="fc" id="L2211">            super( PARAGRAPH, indent, firstLine );</span>
<span class="fc" id="L2212">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2218">            AptParser.this.sink.paragraph();</span>
<span class="fc" id="L2219">            traverseText( skipSpaceFrom( 0 ) );</span>
<span class="fc" id="L2220">            AptParser.this.sink.paragraph_();</span>
<span class="fc" id="L2221">        }</span>
    }

    /** A Comment Block. */
    private class Comment
        extends Block
    {
        /**
         * Constructor.
         *
         * @param line the comment line.
         * @throws AptParseException AptParseException
         */
        Comment( String line )
            throws AptParseException
<span class="fc" id="L2236">        {</span>
<span class="fc" id="L2237">            super( COMMENT_BLOCK, 0, line );</span>
<span class="fc" id="L2238">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="pc bpc" id="L2244" title="1 of 2 branches missed.">            if ( isEmitComments() )</span>
            {
<span class="fc" id="L2246">                AptParser.this.sink.comment( text );</span>
            }
<span class="fc" id="L2248">        }</span>
    }

    /** A Verbatim Block. */
    private class Verbatim
        extends Block
    {
        /** boxed. */
        private boolean boxed;

        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Verbatim( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2267">        {</span>
<span class="fc" id="L2268">            super( VERBATIM, indent, null );</span>

            // Read block (first line already skipped) ---

<span class="fc" id="L2272">            StringBuilder buffer = new StringBuilder();</span>
<span class="fc" id="L2273">            char firstChar = firstLine.charAt( 0 );</span>
<span class="fc bfc" id="L2274" title="All 2 branches covered.">            boxed = ( firstChar == PLUS );</span>

<span class="pc bpc" id="L2276" title="1 of 2 branches missed.">            while ( AptParser.this.line != null )</span>
            {
<span class="fc" id="L2278">                String l = AptParser.this.line;</span>
<span class="fc" id="L2279">                int length = l.length();</span>

<span class="pc bpc" id="L2281" title="1 of 4 branches missed.">                if ( AptParser.charAt( l, length, 0 ) == firstChar &amp;&amp; AptParser.charAt( l, length, 1 ) == MINUS</span>
<span class="pc bpc" id="L2282" title="1 of 2 branches missed.">                    &amp;&amp; AptParser.charAt( l, length, 2 ) == MINUS )</span>
                {
<span class="fc" id="L2284">                    AptParser.this.nextLine();</span>

<span class="fc" id="L2286">                    break;</span>
                }

                // Expand tabs ---

                int prevColumn, column;

<span class="fc" id="L2293">                column = 0;</span>

<span class="fc bfc" id="L2295" title="All 2 branches covered.">                for ( int i = 0; i &lt; length; ++i )</span>
                {
<span class="fc" id="L2297">                    char c = l.charAt( i );</span>

<span class="pc bpc" id="L2299" title="1 of 2 branches missed.">                    if ( c == TAB )</span>
                    {
<span class="nc" id="L2301">                        prevColumn = column;</span>

<span class="nc" id="L2303">                        column = ( ( column + 1 + TAB_WIDTH - 1 ) / TAB_WIDTH ) * TAB_WIDTH;</span>

<span class="nc" id="L2305">                        buffer.append( SPACES, 0, column - prevColumn );</span>
                    }
                    else
                    {
<span class="fc" id="L2309">                        ++column;</span>
<span class="fc" id="L2310">                        buffer.append( c );</span>
                    }
                }
<span class="fc" id="L2313">                buffer.append( EOL );</span>

<span class="fc" id="L2315">                AptParser.this.nextLine();</span>
<span class="fc" id="L2316">            }</span>

            // The last '\n' is mandatory before the &quot;---&quot; delimeter but is
            // not part of the verbatim text.
<span class="fc" id="L2320">            textLength = buffer.length();</span>

<span class="pc bpc" id="L2322" title="1 of 2 branches missed.">            if ( textLength &gt; 0 )</span>
            {
<span class="fc" id="L2324">                --textLength;</span>

<span class="fc" id="L2326">                buffer.setLength( textLength );</span>
            }

<span class="fc" id="L2329">            text = buffer.toString();</span>
<span class="fc" id="L2330">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc bfc" id="L2336" title="All 2 branches covered.">            AptParser.this.sink.verbatim( boxed ? SinkEventAttributeSet.BOXED : null );</span>
<span class="fc" id="L2337">            AptParser.this.sink.text( text );</span>
<span class="fc" id="L2338">            AptParser.this.sink.verbatim_();</span>
<span class="fc" id="L2339">        }</span>
    }

    /** A Figure Block. */
    private class Figure
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Figure( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2355">        {</span>
<span class="fc" id="L2356">            super( FIGURE, indent, firstLine );</span>
<span class="fc" id="L2357">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2363">            AptParser.this.sink.figure();</span>

<span class="fc" id="L2365">            int i = skipFromLeftToRightBracket( 0 );</span>
<span class="fc" id="L2366">            AptParser.this.sink.figureGraphics( text.substring( 1, i ) );</span>

<span class="fc" id="L2368">            i = skipSpaceFrom( i + 1 );</span>
<span class="pc bpc" id="L2369" title="1 of 2 branches missed.">            if ( i &lt; textLength )</span>
            {
<span class="fc" id="L2371">                AptParser.this.sink.figureCaption();</span>
<span class="fc" id="L2372">                traverseText( i );</span>
<span class="fc" id="L2373">                AptParser.this.sink.figureCaption_();</span>
            }

<span class="fc" id="L2376">            AptParser.this.sink.figure_();</span>
<span class="fc" id="L2377">        }</span>
    }

    /** A Table Block. */
    private class Table
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        Table( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2393">        {</span>
<span class="fc" id="L2394">            super( TABLE, indent, firstLine );</span>
<span class="fc" id="L2395">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2401">            int captionIndex = -1;</span>
<span class="fc" id="L2402">            int nextLineIndex = 0;</span>
<span class="fc" id="L2403">            int init = 2;</span>
<span class="fc" id="L2404">            int[] justification = null;</span>
<span class="fc" id="L2405">            int rows = 0;</span>
<span class="fc" id="L2406">            int columns = 0;</span>
<span class="fc" id="L2407">            StringBuilder[] cells = null;</span>
<span class="fc" id="L2408">            boolean[] headers = null;</span>
            boolean grid;

<span class="fc" id="L2411">            AptParser.this.sink.table();</span>

<span class="fc bfc" id="L2413" title="All 2 branches covered.">            while ( nextLineIndex &lt; textLength )</span>
            {
<span class="fc" id="L2415">                int i = text.indexOf( &quot;*--&quot;, nextLineIndex );</span>
<span class="fc bfc" id="L2416" title="All 2 branches covered.">                if ( i &lt; 0 )</span>
                {
<span class="fc" id="L2418">                    captionIndex = nextLineIndex;</span>
<span class="fc" id="L2419">                    break;</span>
                }

                String line;
<span class="fc" id="L2423">                i = text.indexOf( '\n', nextLineIndex );</span>
<span class="fc bfc" id="L2424" title="All 2 branches covered.">                if ( i &lt; 0 )</span>
                {
<span class="fc" id="L2426">                    line = text.substring( nextLineIndex );</span>
<span class="fc" id="L2427">                    nextLineIndex = textLength;</span>
                }
                else
                {
<span class="fc" id="L2431">                    line = text.substring( nextLineIndex, i );</span>
<span class="fc" id="L2432">                    nextLineIndex = i + 1;</span>
                }
<span class="fc" id="L2434">                int lineLength = line.length();</span>

<span class="fc bfc" id="L2436" title="All 2 branches covered.">                if ( line.indexOf( &quot;*--&quot; ) == 0 )</span>
                {
<span class="fc bfc" id="L2438" title="All 2 branches covered.">                    if ( init == 2 )</span>
                    {
<span class="fc" id="L2440">                        init = 1;</span>
<span class="fc" id="L2441">                        justification = parseJustification( line, lineLength );</span>
<span class="fc" id="L2442">                        columns = justification.length;</span>
<span class="fc" id="L2443">                        cells = new StringBuilder[columns];</span>
<span class="fc" id="L2444">                        headers = new boolean[columns];</span>
<span class="fc bfc" id="L2445" title="All 2 branches covered.">                        for ( i = 0; i &lt; columns; ++i )</span>
                        {
<span class="fc" id="L2447">                            cells[i] = new StringBuilder();</span>
<span class="fc" id="L2448">                            headers[i] = false;</span>
                        }
                    }
                    else
                    {
<span class="pc bpc" id="L2453" title="1 of 2 branches missed.">                        if ( traverseRow( cells, headers, justification ) )</span>
                        {
<span class="fc" id="L2455">                            ++rows;</span>
                        }
<span class="fc" id="L2457">                        justification = parseJustification( line, lineLength );</span>
                    }
                }
                else
                {
<span class="fc bfc" id="L2462" title="All 2 branches covered.">                    if ( init == 1 )</span>
                    {
<span class="fc" id="L2464">                        init = 0;</span>
<span class="fc bfc" id="L2465" title="All 2 branches covered.">                        grid = ( AptParser.charAt( line, lineLength, 0 ) == PIPE );</span>
<span class="fc" id="L2466">                        AptParser.this.sink.tableRows( justification, grid );</span>
                    }

<span class="fc" id="L2469">                    line = replaceAll( line, &quot;\\|&quot;, &quot;\\u007C&quot; );</span>

<span class="fc" id="L2471">                    StringTokenizer cellLines = new StringTokenizer( line, &quot;|&quot;, true );</span>

<span class="fc" id="L2473">                    i = 0;</span>
<span class="fc" id="L2474">                    boolean processedGrid = false;</span>
<span class="fc bfc" id="L2475" title="All 2 branches covered.">                    while ( cellLines.hasMoreTokens() )</span>
                    {
<span class="fc" id="L2477">                        String cellLine = cellLines.nextToken();</span>
<span class="fc bfc" id="L2478" title="All 2 branches covered.">                        if ( &quot;|&quot;.equals( cellLine ) )</span>
                        {
<span class="fc bfc" id="L2480" title="All 2 branches covered.">                            if ( processedGrid )</span>
                            {
<span class="fc" id="L2482">                                headers[i] = true;</span>
                            }
                            else
                            {
<span class="fc" id="L2486">                                processedGrid = true;</span>
<span class="fc" id="L2487">                                headers[i] = false;</span>
                            }
<span class="fc" id="L2489">                            continue;</span>
                        }
<span class="fc" id="L2491">                        processedGrid = false;</span>
<span class="fc" id="L2492">                        cellLine = replaceAll( cellLine, &quot;\\&quot;, &quot;\\u00A0&quot; ); // linebreak</span>
                        // Escaped special characters: \~, \=, \-, \+, \*, \[, \], \&lt;, \&gt;, \{, \}, \\.
<span class="fc" id="L2494">                        cellLine = replaceAll( cellLine, &quot;\\u00A0~&quot;, &quot;\\~&quot; );</span>
<span class="fc" id="L2495">                        cellLine = replaceAll( cellLine, &quot;\\u00A0=&quot;, &quot;\\=&quot; );</span>
<span class="fc" id="L2496">                        cellLine = replaceAll( cellLine, &quot;\\u00A0-&quot;, &quot;\\-&quot; );</span>
<span class="fc" id="L2497">                        cellLine = replaceAll( cellLine, &quot;\\u00A0+&quot;, &quot;\\+&quot; );</span>
<span class="fc" id="L2498">                        cellLine = replaceAll( cellLine, &quot;\\u00A0*&quot;, &quot;\\*&quot; );</span>
<span class="fc" id="L2499">                        cellLine = replaceAll( cellLine, &quot;\\u00A0[&quot;, &quot;\\[&quot; );</span>
<span class="fc" id="L2500">                        cellLine = replaceAll( cellLine, &quot;\\u00A0]&quot;, &quot;\\]&quot; );</span>
<span class="fc" id="L2501">                        cellLine = replaceAll( cellLine, &quot;\\u00A0&lt;&quot;, &quot;\\&lt;&quot; );</span>
<span class="fc" id="L2502">                        cellLine = replaceAll( cellLine, &quot;\\u00A0&gt;&quot;, &quot;\\&gt;&quot; );</span>
<span class="fc" id="L2503">                        cellLine = replaceAll( cellLine, &quot;\\u00A0{&quot;, &quot;\\{&quot; );</span>
<span class="fc" id="L2504">                        cellLine = replaceAll( cellLine, &quot;\\u00A0}&quot;, &quot;\\}&quot; );</span>
<span class="fc" id="L2505">                        cellLine = replaceAll( cellLine, &quot;\\u00A0u&quot;, &quot;\\u&quot; );</span>
<span class="fc" id="L2506">                        cellLine = replaceAll( cellLine, &quot;\\u00A0\\u00A0&quot;, &quot;\\\\&quot; );</span>
<span class="fc" id="L2507">                        cellLine = cellLine.trim();</span>

<span class="fc" id="L2509">                        StringBuilder cell = cells[i];</span>
<span class="fc bfc" id="L2510" title="All 2 branches covered.">                        if ( cellLine.length() &gt; 0 )</span>
                        {
                            // line break in table cells
<span class="fc bfc" id="L2513" title="All 2 branches covered.">                            if ( cell.toString().trim().endsWith( &quot;\\u00A0&quot; ) )</span>
                            {
<span class="fc" id="L2515">                                cell.append( &quot;\\\n&quot; );</span>
                            }
                            else
                            {
<span class="fc bfc" id="L2519" title="All 2 branches covered.">                                if ( cell.length() != 0 )</span>
                                {
                                    // Always add a space for multi line tables cells
<span class="fc" id="L2522">                                    cell.append( &quot; &quot; );</span>
                                }
                            }

<span class="fc" id="L2526">                            cell.append( cellLine );</span>
                        }

<span class="fc" id="L2529">                        ++i;</span>
<span class="fc bfc" id="L2530" title="All 2 branches covered.">                        if ( i == columns )</span>
                        {
<span class="fc" id="L2532">                            break;</span>
                        }
<span class="fc" id="L2534">                    }</span>
                }
<span class="fc" id="L2536">            }</span>
<span class="pc bpc" id="L2537" title="1 of 2 branches missed.">            if ( rows == 0 )</span>
            {
<span class="nc" id="L2539">                throw new AptParseException( &quot;no table rows&quot; );</span>
            }
<span class="fc" id="L2541">            AptParser.this.sink.tableRows_();</span>

<span class="fc bfc" id="L2543" title="All 2 branches covered.">            if ( captionIndex &gt;= 0 )</span>
            {
<span class="fc" id="L2545">                AptParser.this.sink.tableCaption();</span>
<span class="fc" id="L2546">                AptParser.this.doTraverseText( text, captionIndex, textLength, AptParser.this.sink );</span>
<span class="fc" id="L2547">                AptParser.this.sink.tableCaption_();</span>
            }

<span class="fc" id="L2550">            AptParser.this.sink.table_();</span>
<span class="fc" id="L2551">        }</span>

        /**
         * Parse a table justification line.
         *
         * @param jline the justification line.
         * @param lineLength the length of the line. Must be &gt; 2.
         * @return int[]
         * @throws AptParseException if something goes wrong.
         */
        private int[] parseJustification( String jline, int lineLength )
            throws AptParseException
        {
<span class="fc" id="L2564">            int columns = 0;</span>

<span class="fc bfc" id="L2566" title="All 2 branches covered.">            for ( int i = 2 /*Skip '*--'*/; i &lt; lineLength; ++i )</span>
            {
<span class="fc bfc" id="L2568" title="All 2 branches covered.">                switch ( jline.charAt( i ) )</span>
                {
                    case STAR:
                    case PLUS:
                    case COLON:
<span class="fc" id="L2573">                        ++columns;</span>
<span class="fc" id="L2574">                        break;</span>
                    default:
                        break;
                }
            }

<span class="pc bpc" id="L2580" title="1 of 2 branches missed.">            if ( columns == 0 )</span>
            {
<span class="nc" id="L2582">                throw new AptParseException( &quot;no columns specified&quot; );</span>
            }

<span class="fc" id="L2585">            int[] justification = new int[columns];</span>
<span class="fc" id="L2586">            columns = 0;</span>
<span class="fc bfc" id="L2587" title="All 2 branches covered.">            for ( int i = 2; i &lt; lineLength; ++i )</span>
            {
<span class="fc bfc" id="L2589" title="All 4 branches covered.">                switch ( jline.charAt( i ) )</span>
                {
                    case STAR:
<span class="fc" id="L2592">                        justification[columns++] = Sink.JUSTIFY_CENTER;</span>
<span class="fc" id="L2593">                        break;</span>
                    case PLUS:
<span class="fc" id="L2595">                        justification[columns++] = Sink.JUSTIFY_LEFT;</span>
<span class="fc" id="L2596">                        break;</span>
                    case COLON:
<span class="fc" id="L2598">                        justification[columns++] = Sink.JUSTIFY_RIGHT;</span>
<span class="fc" id="L2599">                        break;</span>
                    default:
                        break;
                }
            }

<span class="fc" id="L2605">            return justification;</span>
        }

        /**
         * Traverse a table row.
         *
         * @param cells The table cells.
         * @param headers true for header cells.
         * @param justification the justification for each cell.
         * @return boolean
         * @throws AptParseException if something goes wrong.
         */
        private boolean traverseRow( StringBuilder[] cells, boolean[] headers, int[] justification )
            throws AptParseException
        {
            // Skip empty row (a decorative line).
<span class="fc" id="L2621">            boolean traversed = false;</span>
<span class="pc bpc" id="L2622" title="1 of 2 branches missed.">            for ( StringBuilder cell1 : cells )</span>
            {
<span class="pc bpc" id="L2624" title="1 of 2 branches missed.">                if ( cell1.length() &gt; 0 )</span>
                {
<span class="fc" id="L2626">                    traversed = true;</span>
<span class="fc" id="L2627">                    break;</span>
                }
            }

<span class="pc bpc" id="L2631" title="1 of 2 branches missed.">            if ( traversed )</span>
            {
<span class="fc" id="L2633">                AptParser.this.sink.tableRow();</span>
<span class="fc bfc" id="L2634" title="All 2 branches covered.">                for ( int i = 0; i &lt; cells.length; ++i )</span>
                {
<span class="fc" id="L2636">                    StringBuilder cell = cells[i];</span>

                    SinkEventAttributes justif;
<span class="pc bpc" id="L2639" title="1 of 4 branches missed.">                    switch ( justification[i] )</span>
                    {
                        case Sink.JUSTIFY_CENTER:
<span class="fc" id="L2642">                            justif = SinkEventAttributeSet.CENTER;</span>
<span class="fc" id="L2643">                            break;</span>
                        case Sink.JUSTIFY_LEFT:
<span class="fc" id="L2645">                            justif = SinkEventAttributeSet.LEFT;</span>
<span class="fc" id="L2646">                            break;</span>
                        case Sink.JUSTIFY_RIGHT:
<span class="fc" id="L2648">                            justif = SinkEventAttributeSet.RIGHT;</span>
<span class="fc" id="L2649">                            break;</span>
                        default:
<span class="nc" id="L2651">                            justif = SinkEventAttributeSet.LEFT;</span>
                            break;
                    }
<span class="fc" id="L2654">                    SinkEventAttributeSet event = new SinkEventAttributeSet();</span>
<span class="fc" id="L2655">                    event.addAttributes( justif );</span>

<span class="fc bfc" id="L2657" title="All 2 branches covered.">                    if ( headers[i] )</span>
                    {
<span class="fc" id="L2659">                        AptParser.this.sink.tableHeaderCell( event );</span>
                    }
                    else
                    {
<span class="fc" id="L2663">                        AptParser.this.sink.tableCell( event );</span>
                    }
<span class="fc bfc" id="L2665" title="All 2 branches covered.">                    if ( cell.length() &gt; 0 )</span>
                    {
<span class="fc" id="L2667">                        AptParser.this.doTraverseText( cell.toString(), 0, cell.length(), AptParser.this.sink );</span>
<span class="fc" id="L2668">                        cell.setLength( 0 );</span>
                    }
<span class="fc bfc" id="L2670" title="All 2 branches covered.">                    if ( headers[i] )</span>
                    {
<span class="fc" id="L2672">                        AptParser.this.sink.tableHeaderCell_();</span>
                        // DOXIA-404: reset header for next row
<span class="fc" id="L2674">                        headers[i] = false;</span>
                    }
                    else
                    {
<span class="fc" id="L2678">                        AptParser.this.sink.tableCell_();</span>
                    }
                }
<span class="fc" id="L2681">                AptParser.this.sink.tableRow_();</span>
            }

<span class="fc" id="L2684">            return traversed;</span>
        }
    }

    /** A ListItem Block. */
    private class ListItem
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        ListItem( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2701">        {</span>
<span class="fc" id="L2702">            super( LIST_ITEM, indent, firstLine );</span>
<span class="fc" id="L2703">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2709">            traverseText( skipLeadingBullets() );</span>
<span class="fc" id="L2710">        }</span>
    }

    /** A NumberedListItem Block. */
    private class NumberedListItem
        extends Block
    {
        /** numbering. */
        private int numbering;

        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @param number numbering.
         * @throws AptParseException AptParseException
         */
        NumberedListItem( int indent, String firstLine, int number )
            throws AptParseException
<span class="fc" id="L2730">        {</span>
<span class="fc" id="L2731">            super( NUMBERED_LIST_ITEM, indent, firstLine );</span>
<span class="fc" id="L2732">            this.numbering = number;</span>
<span class="fc" id="L2733">        }</span>

        /**
         * getNumbering.
         *
         * @return int
         */
        public int getNumbering()
        {
<span class="fc" id="L2742">            return numbering;</span>
        }

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2749">            traverseText( skipItemNumber() );</span>
<span class="fc" id="L2750">        }</span>

        /**
         * skipItemNumber.
         *
         * @return int
         * @throws AptParseException AptParseException
         */
        private int skipItemNumber()
            throws AptParseException
        {
<span class="fc" id="L2761">            int i = skipSpaceFrom( 0 );</span>

<span class="fc" id="L2763">            char prevChar = SPACE;</span>
<span class="pc bpc" id="L2764" title="1 of 2 branches missed.">            for ( ; i &lt; textLength; ++i )</span>
            {
<span class="fc" id="L2766">                char c = text.charAt( i );</span>
<span class="fc bfc" id="L2767" title="All 4 branches covered.">                if ( c == RIGHT_SQUARE_BRACKET &amp;&amp; prevChar == RIGHT_SQUARE_BRACKET )</span>
                {
<span class="fc" id="L2769">                    break;</span>
                }
<span class="fc" id="L2771">                prevChar = c;</span>
            }

<span class="pc bpc" id="L2774" title="1 of 2 branches missed.">            if ( i == textLength )</span>
            {
<span class="nc" id="L2776">                throw new AptParseException( &quot;missing '&quot; + RIGHT_SQUARE_BRACKET + RIGHT_SQUARE_BRACKET + &quot;'&quot; );</span>
            }

<span class="fc" id="L2779">            return skipSpaceFrom( i + 1 );</span>
        }
    }

    /** A DefinitionListItem Block. */
    private class DefinitionListItem
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        DefinitionListItem( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2796">        {</span>
<span class="fc" id="L2797">            super( DEFINITION_LIST_ITEM, indent, firstLine );</span>
<span class="fc" id="L2798">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2804">            int i = skipSpaceFrom( 0 );</span>
<span class="fc" id="L2805">            int j = skipFromLeftToRightBracket( i );</span>

<span class="fc" id="L2807">            AptParser.this.sink.definedTerm();</span>
<span class="fc" id="L2808">            traverseText( i + 1, j );</span>
<span class="fc" id="L2809">            AptParser.this.sink.definedTerm_();</span>

<span class="fc" id="L2811">            j = skipSpaceFrom( j + 1 );</span>
<span class="pc bpc" id="L2812" title="1 of 2 branches missed.">            if ( j == textLength )</span>
            {
                // TODO: this doesn't handle the case of a dd in a paragraph
                //throw new AptParseException( &quot;no definition&quot; );
            }

<span class="fc" id="L2818">            AptParser.this.sink.definition();</span>
<span class="fc" id="L2819">            traverseText( j );</span>
<span class="fc" id="L2820">        }</span>
    }

    /** A HorizontalRule Block. */
    private class HorizontalRule
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        HorizontalRule( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2836">        {</span>
<span class="fc" id="L2837">            super( HORIZONTAL_RULE, indent, firstLine );</span>
<span class="fc" id="L2838">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2844">            AptParser.this.sink.horizontalRule();</span>
<span class="fc" id="L2845">        }</span>
    }

    /** A PageBreak Block. */
    private class PageBreak
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        PageBreak( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2861">        {</span>
<span class="fc" id="L2862">            super( PG_BREAK, indent, firstLine );</span>
<span class="fc" id="L2863">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc" id="L2869">            AptParser.this.sink.pageBreak();</span>
<span class="fc" id="L2870">        }</span>
    }

    /** A MacroBlock Block. */
    private class MacroBlock
        extends Block
    {
        /**
         * Constructor.
         *
         * @param indent indent.
         * @param firstLine the first line.
         * @throws AptParseException AptParseException
         */
        MacroBlock( int indent, String firstLine )
            throws AptParseException
<span class="fc" id="L2886">        {</span>
<span class="fc" id="L2887">            super( MACRO, indent );</span>

<span class="fc" id="L2889">            text = firstLine;</span>
<span class="fc" id="L2890">        }</span>

        /** {@inheritDoc} */
        public void traverse()
            throws AptParseException
        {
<span class="fc bfc" id="L2896" title="All 2 branches covered.">            if ( isSecondParsing() )</span>
            {
<span class="fc" id="L2898">                return;</span>
            }

<span class="fc" id="L2901">            final int start = text.indexOf( '{' );</span>
<span class="fc" id="L2902">            final int end = text.indexOf( '}' );</span>

<span class="fc" id="L2904">            String s = text.substring( start + 1, end );</span>

<span class="fc" id="L2906">            s = escapeForMacro( s );</span>

<span class="fc" id="L2908">            String[] params = StringUtils.split( s, &quot;|&quot; );</span>

<span class="fc" id="L2910">            String macroId = params[0];</span>

<span class="fc" id="L2912">            Map&lt;String, Object&gt; parameters = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L2914" title="All 2 branches covered.">            for ( int i = 1; i &lt; params.length; i++ )</span>
            {
<span class="fc" id="L2916">                String[] param = StringUtils.split( params[i], &quot;=&quot; );</span>

<span class="pc bpc" id="L2918" title="1 of 2 branches missed.">                if ( param.length == 1 )</span>
                {
<span class="nc" id="L2920">                    throw new AptParseException( &quot;Missing 'key=value' pair for macro parameter: &quot; + params[i] );</span>
                }

<span class="fc" id="L2923">                String key = unescapeForMacro( param[0] );</span>
<span class="fc" id="L2924">                String value = unescapeForMacro( param[1] );</span>

<span class="fc" id="L2926">                parameters.put( key, value );</span>
            }

            // getBasedir() does not work in multi-module builds, see DOXIA-373
            // the basedir should be injected from here, see DOXIA-224
<span class="fc" id="L2931">            MacroRequest request = new MacroRequest( sourceContent, new AptParser(), parameters, getBasedir() );</span>
            try
            {
<span class="fc" id="L2934">                AptParser.this.executeMacro( macroId, request, sink );</span>
            }
<span class="nc" id="L2936">            catch ( MacroExecutionException e )</span>
            {
<span class="nc" id="L2938">                throw new AptParseException( &quot;Unable to execute macro in the APT document&quot;, e );</span>
            }
<span class="nc" id="L2940">            catch ( MacroNotFoundException e )</span>
            {
<span class="nc" id="L2942">                throw new AptParseException( &quot;Unable to find macro used in the APT document&quot;, e );</span>
<span class="fc" id="L2943">            }</span>
<span class="fc" id="L2944">        }</span>

        /**
         * escapeForMacro
         *
         * @param s String
         * @return String
         */
        private String escapeForMacro( String s )
        {
<span class="pc bpc" id="L2954" title="2 of 4 branches missed.">            if ( s == null || s.length() &lt; 1 )</span>
            {
<span class="nc" id="L2956">                return s;</span>
            }

<span class="fc" id="L2959">            String result = s;</span>

            // use some outrageously out-of-place chars for text
            // (these are device control one/two in unicode)
<span class="fc" id="L2963">            result = StringUtils.replace( result, &quot;\\=&quot;, &quot;\u0011&quot; );</span>
<span class="fc" id="L2964">            result = StringUtils.replace( result, &quot;\\|&quot;, &quot;\u0012&quot; );</span>

<span class="fc" id="L2966">            return result;</span>
        }

        /**
         * unescapeForMacro
         *
         * @param s String
         * @return String
         */
        private String unescapeForMacro( String s )
        {
<span class="pc bpc" id="L2977" title="2 of 4 branches missed.">            if ( s == null || s.length() &lt; 1 )</span>
            {
<span class="nc" id="L2979">                return s;</span>
            }

<span class="fc" id="L2982">            String result = s;</span>

<span class="fc" id="L2984">            result = StringUtils.replace( result, &quot;\u0011&quot;, &quot;=&quot; );</span>
<span class="fc" id="L2985">            result = StringUtils.replace( result, &quot;\u0012&quot;, &quot;|&quot; );</span>

<span class="fc" id="L2987">            return result;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>